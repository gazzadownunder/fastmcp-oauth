# Inspector-Style Authentication Setup Guide

## Overview

The Inspector-Style authentication method implements OAuth 2.1 **public client** flow, matching the MCP Inspector's behavior. This guide explains how to configure Keycloak to support this authentication method.

## OAuth 2.1 Client Types

### Confidential Clients
- Have secure client credentials (client_secret)
- Can authenticate with authorization server
- Examples: Backend services, server-side applications

### Public Clients
- **Cannot securely store credentials** (browser-based)
- Use **PKCE** instead of client_secret for security
- Examples: Single-page applications (SPAs), mobile apps, MCP Inspector

## Keycloak Configuration for Public Client

### Step 1: Create or Modify Client

1. **Navigate to Keycloak Admin Console**
   - URL: `http://localhost:8080/admin`
   - Realm: `mcp_security`

2. **Go to Clients** ‚Üí Select or create `mcp-oauth`

### Step 2: Configure Client Settings

#### General Settings Tab
- **Client ID**: `mcp-oauth`
- **Name**: `MCP OAuth Public Client`
- **Description**: `OAuth 2.1 public client for browser-based MCP integration`

#### Capability Config
- **Client authentication**: **OFF** ‚ö†Ô∏è CRITICAL
  - This makes it a PUBLIC client
  - No client_secret required
- **Authorization**: OFF (not needed for this flow)
- **Authentication flow**:
  - ‚úÖ **Standard flow**: ON (enables authorization code flow)
  - ‚úÖ **Direct access grants**: ON (optional - for password grant)
  - ‚ùå **Implicit flow**: OFF (deprecated in OAuth 2.1)
  - ‚ùå **Service accounts roles**: OFF (for confidential clients only)

#### Login Settings
- **Root URL**: `http://localhost:3001`
- **Home URL**: `http://localhost:3001`
- **Valid redirect URIs**:
  - `http://localhost:3001/*`
  - `http://localhost:3001/callback`
- **Valid post logout redirect URIs**: `http://localhost:3001/*`
- **Web origins**: `http://localhost:3001`

#### Advanced Settings
- **Proof Key for Code Exchange Code Challenge Method**: `S256` ‚ö†Ô∏è REQUIRED
  - This enforces PKCE for all authorization requests
  - S256 uses SHA-256 hashing (more secure than "plain")

### Step 3: Verify Configuration

After saving, verify in the **Credentials** tab:
- Should show: "No credentials configured for this client"
- This confirms it's a PUBLIC client

## Inspector-Style Token Exchange Flow

### Authorization Request (5 parameters)
```http
GET /realms/mcp_security/protocol/openid-connect/auth?
  response_type=code&
  client_id=mcp-oauth&
  redirect_uri=http://localhost:3001/&
  code_challenge=CVA5GEyz2nB6H4RXASPvBXUZKA2CP0fZDu4RjeD75f8&
  code_challenge_method=S256
```

**Notable Omissions:**
- ‚ùå No `scope` parameter (uses IDP defaults: `openid profile email`)
- ‚ùå No `state` parameter (PKCE provides CSRF protection)

### Token Exchange Request (4 parameters)
```http
POST /realms/mcp_security/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
code=8c15d3d2-918e-4d48-8458-5350ef67e49a.e089be0e-afe2-46a3-af19-d76834df1e50.39e7c16c-c0b6-43c7-8bef-a5470955652b&
redirect_uri=http://localhost:3001/&
client_id=mcp-oauth&
code_verifier=owduct05gq1MuXBYkCnpq2HBKSK-mBjey.Xm813N2H
```

**Notable Omissions:**
- ‚ùå No `client_secret` (public client - PKCE provides security)

## Security Model

### PKCE Security (Replaces client_secret)

**How PKCE Protects Public Clients:**

1. **Code Verifier**: Cryptographically random string (43-128 characters)
   - Generated by client before authorization request
   - Kept secret in browser sessionStorage
   - Never transmitted during authorization

2. **Code Challenge**: SHA-256 hash of code_verifier
   - Sent in authorization request
   - Keycloak stores it with the authorization code

3. **Token Exchange Validation**:
   - Client sends `code_verifier` in token exchange
   - Keycloak hashes it and compares with stored `code_challenge`
   - Match required for token issuance

**Result:** Even if authorization code is intercepted, attacker cannot exchange it without the `code_verifier`.

### Threat Model

| Attack | Protection |
|--------|-----------|
| Authorization Code Interception | PKCE - code useless without verifier |
| CSRF Attack | PKCE - code_challenge binds request to verifier |
| Replay Attack | Authorization code is single-use |
| Client Impersonation | PKCE - attacker cannot generate valid verifier |

## Comparison: Public vs Confidential

| Feature | Confidential Client | Public Client (Inspector) |
|---------|-------------------|---------------------------|
| Client Secret | ‚úÖ Required | ‚ùå None |
| PKCE | ‚ö†Ô∏è Recommended | ‚úÖ Required |
| Security Model | Client credentials | PKCE cryptographic binding |
| Use Case | Backend services | Browser-based apps |
| Token Exchange | Sends client_secret | Sends code_verifier |

## Testing the Inspector-Style Auth

1. **Start Keycloak** (port 8080)
2. **Configure client** as PUBLIC (see above)
3. **Open mcp-client** in browser: `http://localhost:3001`
4. **Click**: üîç Inspector-Style Auth
5. **Observe console logs**:
   - Should show: "Public client (no client_secret - PKCE provides security)"
   - Authorization URL should have 5 parameters
   - Token exchange should NOT include client_secret

6. **Verify token response**:
   - Should receive access_token
   - Should receive id_token (for logout)
   - User session should be established

## Troubleshooting

### Error: "Invalid client credentials"
- **Cause**: Client is configured as CONFIDENTIAL
- **Fix**: Set "Client authentication" to OFF in Keycloak

### Error: "Invalid redirect_uri"
- **Cause**: Redirect URI not in valid list
- **Fix**: Add `http://localhost:3001/*` to "Valid redirect URIs"

### Error: "PKCE verification failed"
- **Cause**: code_verifier doesn't match code_challenge
- **Fix**: Ensure PKCE Code Challenge Method is set to S256 in Keycloak

### Error: "Access denied"
- **Cause**: User doesn't have required roles/scopes
- **Fix**: Assign user to appropriate roles in Keycloak

## References

- [OAuth 2.1 Draft Specification](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-11)
- [RFC 7636 - Proof Key for Code Exchange (PKCE)](https://datatracker.ietf.org/doc/html/rfc7636)
- [OAuth 2.0 for Browser-Based Apps (BCP)](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-browser-based-apps)

## Summary

The Inspector-Style authentication method correctly implements OAuth 2.1 public client flow:
- ‚úÖ No client_secret (browser-based security model)
- ‚úÖ PKCE (S256) provides cryptographic security
- ‚úÖ Minimal parameters (5 in auth request, 4 in token exchange)
- ‚úÖ Matches MCP Inspector behavior
- ‚úÖ OAuth 2.1 compliant
