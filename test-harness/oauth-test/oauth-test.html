<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth 2.0 Token Exchange Test Harness</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .flow-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .flow-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .response-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .response-box {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }

        .response-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .response-content {
            background: #f5f5f5;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
        }

        .error {
            color: #d32f2f;
            font-weight: 600;
        }

        .step-container {
            margin-bottom: 30px;
        }

        .step-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            font-size: 1.3em;
            font-weight: 600;
        }

        .step-content {
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .response-container {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê OAuth 2.0 Token Exchange Test Harness</h1>
        <p class="subtitle">RFC 8693 Two-Step Token Exchange Demonstration</p>

        <div class="flow-section">
            <h2>üìã Test Flows</h2>
            <p style="margin-bottom: 15px; color: #666;">
                <strong>Step 1:</strong> Obtain initial access token (subject token)<br>
                <strong>Step 2:</strong> Exchange subject token for delegation token using RFC 8693
            </p>

            <div class="button-group">
                <button id="startDirectGrantButton">üîë Flow 1A: Direct Grant (Password)</button>
                <button id="loginSsoButton">üåê Flow 1B: SSO Redirect (Auth Code)</button>
            </div>
        </div>

        <div class="step-container">
            <div class="step-header">Step 1: Initial Token (Subject Token)</div>
            <div class="step-content">
                <div class="response-container">
                    <div class="response-box">
                        <h3>üìÑ Token Response</h3>
                        <div id="step1Response" class="response-content">Ready...</div>
                    </div>
                    <div class="response-box">
                        <h3>üîç Decoded JWT Claims</h3>
                        <div id="decodedJwtClaimsStep1" class="response-content">Ready...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="step-container">
            <div class="step-header">Step 2: Token Exchange (Delegation Token)</div>
            <div class="step-content">
                <div class="response-container">
                    <div class="response-box">
                        <h3>üìÑ Token Response</h3>
                        <div id="step2Response" class="response-content">Waiting for Step 1...</div>
                    </div>
                    <div class="response-box">
                        <h3>üîç Decoded JWT Claims</h3>
                        <div id="decodedJwtClaimsStep2" class="response-content">Waiting for Step 1...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- Constants and Global References ---
    const tokenEndpoint = 'http://localhost:8080/realms/mcp_security/protocol/openid-connect/token';
    const authEndpoint = 'http://localhost:8080/realms/mcp_security/protocol/openid-connect/auth';
    const clientId = 'mcp-oauth';
    const redirectUri = window.location.origin + window.location.pathname;

    const step1ResponseDiv = document.getElementById('step1Response');
    const decodedJwtDivStep1 = document.getElementById('decodedJwtClaimsStep1');
    const step2ResponseDiv = document.getElementById('step2Response');
    const decodedJwtDivStep2 = document.getElementById('decodedJwtClaimsStep2');

    // --- Core Functions ---

    /** Resets all display areas to their initial state */
    function resetDisplays(step1Message = 'Ready...', step2Message = 'Waiting for Step 1...') {
        step1ResponseDiv.textContent = step1Message;
        decodedJwtDivStep1.textContent = step1Message;
        step2ResponseDiv.textContent = step2Message;
        decodedJwtDivStep2.textContent = step2Message;
    }

    /** Decodes a JWT payload */
    function decodeJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            return { error: "Failed to decode JWT", details: e.message };
        }
    }

    /** Handles displaying errors in the UI */
    function handleError(error, step) {
        console.error('OAuth Flow Error:', error);
        const errorMessage = `<span class="error">${error.message}</span>`;
        if (step === 1) {
            step1ResponseDiv.innerHTML = errorMessage;
            decodedJwtDivStep1.textContent = 'Step 1 failed.';
            // Reset Step 2 display as it cannot proceed
            step2ResponseDiv.textContent = 'Step 1 failed.';
            decodedJwtDivStep2.textContent = 'Step 1 failed.';
        } else if (step === 2) {
            step2ResponseDiv.innerHTML = errorMessage;
            decodedJwtDivStep2.textContent = 'Step 2 failed.';
        } else {
            step1ResponseDiv.innerHTML = `<span class="error">An unexpected error occurred: ${error.message}</span>`;
        }
    }

    /** Performs Step 2: Token Exchange */
    async function performTokenExchange(subjectToken) {
        console.log('=== STEP 2: Token Exchange Started ===');
        console.log('Subject Token:', subjectToken);

        step2ResponseDiv.textContent = 'Making token exchange request...';
        decodedJwtDivStep2.textContent = 'Making token exchange request...';

        const step2FormData = new URLSearchParams();
        step2FormData.append('grant_type', 'urn:ietf:params:oauth:grant-type:token-exchange');
        step2FormData.append('client_id', 'mcp-server-client');
        step2FormData.append('audience', 'mcp-server-client');
        step2FormData.append('client_secret', 'JUUA5xCJDQZdreWgEFYvfAqjJnGdTXXA');
        step2FormData.append('subject_token', subjectToken);
        step2FormData.append('subject_token_type', 'urn:ietf:params:oauth:token-type:access_token');
        step2FormData.append('requested_token_type', 'urn:ietf:params:oauth:token-type:access_token');

        console.log('Token Exchange Request Parameters:');
        console.log('  grant_type:', 'urn:ietf:params:oauth:grant-type:token-exchange');
        console.log('  client_id:', 'token_exchange');
        console.log('  audience:', 'token_exchange');
        console.log('  subject_token_type:', 'urn:ietf:params:oauth:token-type:access_token');

        const response = await fetch(tokenEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: step2FormData.toString()
        });

        const data = await response.json();
        console.log('Token Exchange Response Status:', response.status);
        console.log('Token Exchange Response:', data);

        step2ResponseDiv.textContent = JSON.stringify(data, null, 2);

        if (!response.ok || !data.access_token) {
            console.error('=== STEP 2: Token Exchange Failed ===');
            console.error('Error:', data.error);
            console.error('Error Description:', data.error_description);
            throw new Error(`Step 2 failed: ${data.error_description || data.error || 'Unknown error'}`);
        }

        const decodedClaims = decodeJwt(data.access_token);
        console.log('Token Exchange Decoded Claims:', decodedClaims);
        console.log('=== STEP 2: Token Exchange Completed Successfully ===');

        decodedJwtDivStep2.textContent = JSON.stringify(decodedClaims, null, 2);
    }

    // --- Step 1 Flow Functions ---

    /** Flow 1A: Direct Grant (Client Credentials) */
    async function performDirectGrant() {
        console.log('=== STEP 1A: Direct Grant Started ===');
        console.log('Client ID:', clientId);
        console.log('Username:', 'alice@test.local');

        resetDisplays('Making direct grant request...');
        let step1AccessToken = null;

        // --- Execute Step 1 ---
        try {
            const step1FormData = new URLSearchParams();
            step1FormData.append('grant_type', 'password');
            step1FormData.append('client_id', clientId);
            step1FormData.append('scope', 'email openid');
            step1FormData.append('username', 'alice@test.local');
            step1FormData.append('password', 'Test123!');
            step1FormData.append('client_secret', '9DQjCpm4D9wbzXxHa1ki51PhBbyxOXrg');

            console.log('Direct Grant Request Parameters:');
            console.log('  grant_type: password');
            console.log('  client_id:', clientId);
            console.log('  scope: email openid');

            const response = await fetch(tokenEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: step1FormData.toString()
            });

            const data = await response.json();
            console.log('Direct Grant Response Status:', response.status);
            console.log('Direct Grant Response:', data);

            step1ResponseDiv.textContent = JSON.stringify(data, null, 2);

            if (!response.ok || !data.access_token) {
                console.error('=== STEP 1A: Direct Grant Failed ===');
                console.error('Error:', data.error);
                console.error('Error Description:', data.error_description);
                throw new Error(`Step 1 failed: ${data.error_description || data.error || 'Unknown error'}`);
            }

            const decodedClaims = decodeJwt(data.access_token);
            console.log('Direct Grant Decoded Claims:', decodedClaims);
            console.log('=== STEP 1A: Direct Grant Completed Successfully ===');

            decodedJwtDivStep1.textContent = JSON.stringify(decodedClaims, null, 2);
            step1AccessToken = data.access_token;

        } catch (error) {
            handleError(error, 1);
            return; // Stop if Step 1 fails
        }

        // --- Execute Step 2 (if Step 1 was successful) ---
        if (step1AccessToken) {
            try {
                await performTokenExchange(step1AccessToken);
            } catch (error) {
                handleError(error, 2);
            }
        }
    }

    /** Flow 1B: SSO Redirect */
    function redirectToSso() {
        console.log('=== STEP 1B: SSO Redirect Started ===');
        console.log('Client ID:', clientId);
        console.log('Redirect URI:', redirectUri);
        console.log('Auth Endpoint:', authEndpoint);

        const params = new URLSearchParams({
            client_id: clientId,
            redirect_uri: redirectUri,
            response_type: 'code',
            scope: 'openid email'
        });
        console.log('Redirecting to:', `${authEndpoint}?${params.toString()}`);
        window.location.href = `${authEndpoint}?${params.toString()}`;
    }

    /** Flow 1B: Handles the redirect back from SSO, exchanging the code for a token */
    async function handleSsoCallback(code) {
        console.log('=== STEP 1B: SSO Callback - Authorization Code Exchange ===');
        console.log('Authorization Code:', code);

        resetDisplays('Exchanging authorization code for token...');
        window.history.replaceState({}, document.title, redirectUri);

        let step1AccessToken = null;

        // --- Execute Step 1 ---
        try {
            const formData = new URLSearchParams();
            formData.append('grant_type', 'authorization_code');
            formData.append('code', code);
            formData.append('redirect_uri', redirectUri);
            formData.append('client_id', clientId);
            formData.append('client_secret', '9DQjCpm4D9wbzXxHa1ki51PhBbyxOXrg');

            console.log('Code Exchange Request Parameters:');
            console.log('  grant_type: authorization_code');
            console.log('  client_id:', clientId);
            console.log('  redirect_uri:', redirectUri);

            const response = await fetch(tokenEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData.toString()
            });

            const data = await response.json();
            console.log('Code Exchange Response Status:', response.status);
            console.log('Code Exchange Response:', data);

            step1ResponseDiv.textContent = JSON.stringify(data, null, 2);

            if (!response.ok || !data.access_token) {
                console.error('=== STEP 1B: Code Exchange Failed ===');
                console.error('Error:', data.error);
                console.error('Error Description:', data.error_description);
                throw new Error(`Step 1 (code exchange) failed: ${data.error_description || data.error || 'Unknown error'}`);
            }

            const decodedClaims = decodeJwt(data.access_token);
            console.log('Code Exchange Decoded Claims:', decodedClaims);
            console.log('=== STEP 1B: Code Exchange Completed Successfully ===');

            decodedJwtDivStep1.textContent = JSON.stringify(decodedClaims, null, 2);
            step1AccessToken = data.access_token;

        } catch (error) {
            handleError(error, 1);
            return; // Stop if Step 1 fails
        }

        // --- Execute Step 2 (if Step 1 was successful) ---
        if (step1AccessToken) {
            try {
                await performTokenExchange(step1AccessToken);
            } catch (error) {
                handleError(error, 2);
            }
        }
    }


    // --- Event Listeners ---
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // This code will only run after the HTML is fully loaded
            document.getElementById('startDirectGrantButton').addEventListener('click', performDirectGrant);
            document.getElementById('loginSsoButton').addEventListener('click', redirectToSso);
        });


        // On page load, check if we're coming back from an SSO redirect
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code) {
                handleSsoCallback(code);
            }
        });
</script>
</body>
</html>
