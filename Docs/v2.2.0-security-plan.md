# v2.2.0 Security Hardening Plan - Summary

**Status**: üìã PLANNED
**Target Date**: 2025-10-18
**Estimated Tests**: ~370 tests (+51 new tests from v2.1.0's 319 tests)

## Overview

v2.2.0 addresses **3 critical security gaps** identified in the comprehensive security review ([Docs/Security-review.md](Security-review.md)) while completing remaining architectural improvements.

**Full Implementation Plan**: See [Docs/security-gap-remediation.md](security-gap-remediation.md) for detailed specifications.

---

## Security Gaps to Address

### üî¥ SEC-1: Trust Boundary Violation in Delegation (CRITICAL)

**Problem**: DelegationRegistry trusts module-reported `auditTrail.success` without verification.

**Risk**: Malicious module could hide successful queries or fake failures.

**Solution**:
- Registry independently verifies `result.success` status
- Injects mandatory integrity fields: `moduleReportedSuccess`, `registryVerifiedSuccess`, `registryTimestamp`
- Logs discrepancies as `trust_boundary_violation` security events

**Files Modified**:
- `src/core/types.ts` - Add trust boundary fields to AuditEntry
- `src/delegation/registry.ts` - Implement trust verification logic
- `tests/unit/delegation/registry.test.ts` - Add 15 trust boundary tests

**Framework Intent**: ‚úÖ Preserved - Registry-as-coordinator pattern maintained with enhanced verification

---

### üü° SEC-2: Permissions Inheritance Leak (MEDIUM)

**Problem**: If config includes `customPermissions.unassigned`, assertion might throw during auth.

**Risk**: Configuration error could halt authentication flow.

**Solution**:
- `SessionManager.getPermissions()` early-returns `[]` for `UNASSIGNED_ROLE` (config-independent)
- Schema validation rejects `customPermissions.unassigned` key
- Defense-in-depth: Fail-safe behavior even with malformed config

**Files Modified**:
- `src/core/session-manager.ts` - Early return guard
- `src/config/schemas/core.ts` - Schema validation refinement
- `tests/unit/core/session-manager.test.ts` - Add 8 config guard tests
- `tests/unit/config/schemas.test.ts` - Add 2 validation tests

**Framework Intent**: ‚úÖ Preserved - Zero-default security policy maintained with enhanced fail-safe

---

### üü° SEC-3: Uncontrolled Error Message Exposure (MEDIUM)

**Problem**: Non-security errors (DB, network) may leak stack traces to LLM client.

**Risk**: Information disclosure violates least-information principle.

**Solution**:
- All tool handlers catch **all exceptions** (not just `OAuthSecurityError`)
- Log full technical error to AuditService (for investigation)
- Return generic `SERVER_ERROR` response to client (no stack traces, paths, or internal details)
- Create `handleToolError()` utility for consistent error handling

**Files Created**:
- `src/mcp/utils/error-helpers.ts` - Error masking utility

**Files Modified**:
- `src/mcp/tools/sql-delegate.ts` - Generic error handler
- `src/mcp/tools/health-check.ts` - Generic error handler
- `src/mcp/tools/user-info.ts` - Generic error handler
- `tests/unit/mcp/tools/*.test.ts` - Add 10 error masking tests
- `tests/unit/mcp/utils/error-helpers.test.ts` - Add 4 utility tests (new file)

**Framework Intent**: ‚úÖ Preserved - Security errors still return specific codes; enhanced production-ready error handling

---

## Architecture Gap (from Refactor Plan)

### üü¢ GAP #4: Authorization Helpers Incomplete (LOW)

**Problem**: No separate Authorization class, missing soft check methods for `canAccess`.

**Solution**:
- Extract `src/mcp/authorization.ts` with Authorization class
- Implement soft checks: `hasRole()`, `hasAnyRole()`, `hasPermission()` (return boolean)
- Implement hard checks: `requireRole()`, `requireAnyRole()`, `requirePermission()` (throw errors)
- Update middleware to delegate to Authorization class

**Files Created**:
- `src/mcp/authorization.ts` - Authorization class
- `tests/unit/mcp/authorization.test.ts` - 18 new tests (new file)

**Files Modified**:
- `src/mcp/middleware.ts` - Delegate to Authorization class
- `src/mcp/index.ts` - Export Authorization class

**Framework Intent**: ‚úÖ Preserved - Two-tier security pattern (visibility + execution) formalized

---

## Test Plan Summary

### New Tests by Component

| Component | Tests | Files |
|-----------|-------|-------|
| **Trust Boundary** | 15 | `tests/unit/delegation/registry.test.ts` |
| **Config Guard** | 10 | `tests/unit/core/session-manager.test.ts`, `tests/unit/config/schemas.test.ts` |
| **Error Masking** | 14 | `tests/unit/mcp/tools/*.test.ts`, `tests/unit/mcp/utils/error-helpers.test.ts` |
| **Authorization Class** | 18 | `tests/unit/mcp/authorization.test.ts` |
| **TOTAL NEW** | **51** | **6 test files (2 new, 4 modified)** |

### Expected Test Results

- **Current**: 319/319 tests passing (v2.1.0)
- **Target**: 370/370 tests passing (v2.2.0)
- **Coverage**: 100% pass rate maintained

---

## Implementation Timeline

### Day 1: Trust Boundary (SEC-1)
- Update AuditEntry interface
- Implement trust verification in DelegationRegistry
- Create 15 tests
- **Commit**: "feat(sec): Add trust boundary enforcement to DelegationRegistry"

### Day 2: Config Guard & Error Masking (SEC-2, SEC-3)
- Implement config guard in SessionManager
- Add schema validation
- Create error-helpers utility
- Update all 3 tool handlers
- Create 24 tests
- **Commit**: "feat(sec): Add config guard and error masking"

### Day 3: Authorization Class & Testing (GAP #4)
- Create Authorization class
- Extract soft/hard check methods
- Update middleware delegation
- Create 18 tests
- Run full test suite (370 tests)
- **Commit**: "feat(auth): Extract Authorization class with soft checks"

### Day 4: Documentation & Release
- Update security documentation
- Integration testing with malicious modules
- Performance benchmarks
- Release notes
- **Git tag**: v2.2.0

---

## Risk Mitigation

### Low Risk
‚úÖ **SEC-2 (Config Guard)**: Additive change, no impact on valid configs

### Medium Risk
‚ö†Ô∏è **SEC-3 (Error Masking)**: Touches all tools - comprehensive testing required

### High Risk
üî¥ **SEC-1 (Trust Boundary)**: Changes core delegation flow - extensive testing + performance benchmarks

**Mitigation Strategy**:
1. Phased commits (one security gap per commit)
2. Run full test suite after each commit
3. Integration tests with malicious mock modules
4. Performance benchmarks to ensure <5% overhead
5. Security review validation before release

---

## Success Criteria

v2.2.0 is complete when:

1. ‚úÖ All 3 security gaps closed (SEC-1, SEC-2, SEC-3)
2. ‚úÖ Authorization class extracted (GAP #4)
3. ‚úÖ 370+ tests passing (100% pass rate)
4. ‚úÖ Zero regressions in existing functionality
5. ‚úÖ Documentation updated with security patterns
6. ‚úÖ Performance benchmarks show <5% overhead
7. ‚úÖ All architectural principles maintained:
   - One-way dependency flow (Core ‚Üê Delegation ‚Üê MCP)
   - Zero-default security policy
   - CoreContext injection pattern
   - Fail-safe design (RoleMapper, AuditService)

---

## Framework Intent Validation

All security enhancements preserve core framework principles:

| Principle | Status | Verification |
|-----------|--------|--------------|
| **Zero-Default Security** | ‚úÖ Preserved | Config guard prevents accidental permissions |
| **Defense-in-Depth** | ‚úÖ Enhanced | Trust boundary + error masking add layers |
| **Fail-Safe Design** | ‚úÖ Preserved | Early returns prevent config errors |
| **Least Information** | ‚úÖ Enhanced | Error masking prevents disclosure |
| **Architectural Integrity** | ‚úÖ Preserved | No circular dependencies introduced |
| **Backwards Compatible** | ‚úÖ Maintained | No breaking changes to public APIs |

---

## Documentation Updates

The following documents will be updated in v2.2.0:

1. **[Docs/Security-review.md](Security-review.md)** - Mark all gaps as "‚úÖ CLOSED" with validation results
2. **[CLAUDE.md](../CLAUDE.md)** - Add security patterns section with examples
3. **[README.md](../README.md)** - Add security best practices section
4. **[Docs/refactor-progress.md](refactor-progress.md)** - Update v2.2.0 status to COMPLETE

---

## References

- **Security Review**: [Docs/Security-review.md](Security-review.md)
- **Detailed Implementation**: [Docs/security-gap-remediation.md](security-gap-remediation.md)
- **Refactor Progress**: [Docs/refactor-progress.md](refactor-progress.md)
- **Framework Security Principles**: [Docs/framework-security-principles.md](framework-security-principles.md)
