# WWW-Authenticate Header Issue

## Problem Statement

When using FastMCP@3.22.0 with OAuth authentication, 401 Unauthorized responses are missing the required `WWW-Authenticate` header. This breaks the MCP OAuth 2.1 discovery flow as specified in the MCP specification.

**Expected Behavior:**
```http
HTTP/1.1 401 Unauthorized
Content-Type: application/json
WWW-Authenticate: Bearer realm="MCP Server", authorization_server="http://localhost:8080/realms/mcp_security"
```

**Actual Behavior:**
```http
HTTP/1.1 401 Unauthorized
Content-Type: application/json
```

## Root Cause Analysis

### Issue 1: FastMCP doesn't pass OAuth config to mcp-proxy

**File:** `node_modules/fastmcp/dist/FastMCP.js` (lines ~1445, ~1477)

```javascript
this.#httpStreamServer = await startHTTPServer({
  ...this.#authenticate ? { authenticate: this.#authenticate } : {},
  createServer: async (request) => { ... },
  enableJsonResponse: httpConfig.enableJsonResponse,
  eventStore: httpConfig.eventStore,
  host: httpConfig.host,
  port: httpConfig.port,
  stateless: true,
  streamEndpoint: httpConfig.endpoint
  // MISSING: oauth parameter!
});
```

The FastMCP constructor accepts an `oauth` parameter with `protectedResource.resource` configuration, but this is never passed down to mcp-proxy's `startHTTPServer()` function.

### Issue 2: mcp-proxy only uses static OAuth config

**File:** `node_modules/mcp-proxy/src/startHTTPServer.ts` (lines 262-266)

```typescript
// Add WWW-Authenticate header if OAuth config is available
const wwwAuthHeader = getWWWAuthenticateHeader(oauth);
if (wwwAuthHeader) {
  res.setHeader("WWW-Authenticate", wwwAuthHeader);
}
```

The mcp-proxy code only reads the `oauth` parameter passed to `startHTTPServer()`, not the dynamic `wwwAuthenticate` field from the auth result returned by the `authenticate()` callback.

**File:** `node_modules/mcp-proxy/src/startHTTPServer.ts` (lines 62-70)

```typescript
const getWWWAuthenticateHeader = (
  oauth?: AuthConfig["oauth"],
): string | undefined => {
  if (!oauth?.protectedResource?.resource) {
    return undefined;
  }

  return `Bearer resource_metadata="${oauth.protectedResource.resource}/.well-known/oauth-protected-resource"`;
};
```

This function only generates a basic header pointing to the metadata endpoint. It doesn't use the dynamic header generated by our middleware which includes the `authorization_server` parameter.

### Issue 3: Auth result's wwwAuthenticate field is ignored

**Our middleware** ([src/mcp/middleware.ts:200-205](../src/mcp/middleware.ts)) generates a proper WWW-Authenticate header and returns it in the auth result:

```typescript
return {
  authenticated: false,
  error: error.message,
  statusCode: error.statusCode,
  wwwAuthenticate: wwwAuthenticate, // This field is never read by mcp-proxy!
};
```

But mcp-proxy's `startHTTPServer()` doesn't check for this field when setting HTTP headers.

## Impact

- **MCP OAuth Discovery Flow Broken:** Clients cannot discover the authorization server from 401 responses
- **Non-Compliant with RFC 6750:** Bearer token authentication requires WWW-Authenticate header on 401/403 responses
- **Non-Compliant with MCP Specification:** MCP OAuth 2.1 spec requires proper challenge responses

## Upstream Issues

### FastMCP Issue
FastMCP@3.22.0 should pass the `oauth` configuration from the constructor to mcp-proxy's `startHTTPServer()` call.

**Required Change:**
```javascript
this.#httpStreamServer = await startHTTPServer({
  ...this.#authenticate ? { authenticate: this.#authenticate } : {},
  createServer: async (request) => { ... },
  // ... other params ...
  oauth: this.#oauth, // ADD THIS LINE
});
```

### mcp-proxy Issue
mcp-proxy@5.10.0 should read the `wwwAuthenticate` field from auth results and use it for 401 response headers.

**Required Change in startHTTPServer.ts (line 260):**
```typescript
// Per-request authentication in stateless mode
if (stateless && authenticate) {
  try {
    const authResult = await authenticate(req);

    if (!authResult || (typeof authResult === 'object' && 'authenticated' in authResult && !authResult.authenticated)) {
      const errorMessage = authResult && typeof authResult === 'object' && 'error' in authResult ? authResult.error : "Unauthorized: Authentication failed";

      res.setHeader("Content-Type", "application/json");

      // PRIORITY 1: Use dynamic header from auth result if available
      if (authResult && typeof authResult === 'object' && 'wwwAuthenticate' in authResult && authResult.wwwAuthenticate) {
        res.setHeader("WWW-Authenticate", authResult.wwwAuthenticate);
      }
      // PRIORITY 2: Fallback to static OAuth config
      else {
        const wwwAuthHeader = getWWWAuthenticateHeader(oauth);
        if (wwwAuthHeader) {
          res.setHeader("WWW-Authenticate", wwwAuthHeader);
        }
      }

      res.writeHead(401).end(...);
      return true;
    }
  }
}
```

## Workarounds

### Workaround 1: Throw Response Error with Headers (RECOMMENDED)

Modify our middleware to throw a Response object with headers instead of returning an auth result:

**File:** `src/mcp/middleware.ts`

```typescript
// Instead of returning { authenticated: false, wwwAuthenticate: ... }
// Throw a Response object with headers
if (error instanceof OAuthSecurityError && error.statusCode === 401) {
  const wwwAuthenticate = generateWWWAuthenticateHeader(this.coreContext, 'MCP Server');

  const headers = new Headers();
  headers.set('Content-Type', 'application/json');
  headers.set('WWW-Authenticate', wwwAuthenticate);

  const response = new Response(JSON.stringify({
    error: { code: -32000, message: error.message },
    id: null,
    jsonrpc: '2.0'
  }), {
    status: 401,
    statusText: 'Unauthorized',
    headers
  });

  throw response; // FastMCP handles Response errors specially
}
```

This leverages mcp-proxy's `handleResponseError()` function (startHTTPServer.ts:72-96) which reads headers from thrown Response objects.

### Workaround 2: Patch mcp-proxy locally

Use `patch-package` to modify `node_modules/mcp-proxy/dist/startHTTPServer.js` to read `authResult.wwwAuthenticate`.

### Workaround 3: Wait for upstream fixes

Monitor these repositories for fixes:
- https://github.com/punkpeye/fastmcp/issues
- https://github.com/punkpeye/mcp-proxy/issues

## Test Plan

After implementing workaround, verify with:

```bash
curl -X POST http://localhost:3000/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test-client","version":"1.0"}},"id":1}' \
  -i
```

**Expected output:**
```http
HTTP/1.1 401 Unauthorized
Content-Type: application/json
WWW-Authenticate: Bearer realm="MCP Server", authorization_server="http://localhost:8080/realms/mcp_security"
...
```

## Related Files

- [src/mcp/middleware.ts](../src/mcp/middleware.ts) - Middleware that generates WWW-Authenticate header
- [src/mcp/oauth-metadata.ts](../src/mcp/oauth-metadata.ts) - OAuth metadata generation functions
- [src/mcp/server.ts](../src/mcp/server.ts) - FastMCP server creation with OAuth config
- [test-harness/mcp-client/discovery-auth.js](../test-harness/mcp-client/discovery-auth.js) - MCP OAuth discovery implementation (requires WWW-Authenticate header)

## References

- RFC 6750 ยง3: "The HTTP WWW-Authenticate response header is used to challenge the client..."
- RFC 9728: OAuth 2.0 Protected Resource Metadata
- MCP Specification 2025-03-26: OAuth 2.1 Authentication
- mcp-proxy PR #40: https://github.com/punkpeye/mcp-proxy/pull/40 (claimed to add WWW-Authenticate support)
