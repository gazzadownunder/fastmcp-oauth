
> mcp-oauth-framework@2.0.0 test:coverage
> vitest --coverage


[1m[7m[34m DEV [39m[27m[22m [34mv2.1.9 [39m[90mc:/Users/gazza/Local Documents/GitHub/MCP Services/MCP-Oauth[39m
      [2mCoverage enabled with [22m[33mv8[39m

 [32mâœ“[39m tests/unit/delegation/encrypted-token-cache.test.ts [2m([22m[2m29 tests[22m[2m)[22m[90m 116[2mms[22m[39m
 [32mâœ“[39m tests/unit/core/session-manager.test.ts [2m([22m[2m21 tests[22m[2m)[22m[90m 59[2mms[22m[39m
 [32mâœ“[39m tests/unit/core/audit-service.test.ts [2m([22m[2m20 tests[22m[2m)[22m[90m 105[2mms[22m[39m
[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mCRITICAL: Never Throws Policy[2m > [22m[2mshould NEVER throw on any input
[22m[39m[RoleMapper] determineRoles called with: [1mnull[22m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array
[RoleMapper] determineRoles called with: [90mundefined[39m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array
[RoleMapper] determineRoles called with: invalid
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array
[RoleMapper] determineRoles called with: [33m123[39m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array
[RoleMapper] determineRoles called with: {}
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mCRITICAL: Never Throws Policy[2m > [22m[2mshould return UNASSIGNED_ROLE on invalid input
[22m[39m[RoleMapper] determineRoles called with: [1mnull[22m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mCRITICAL: Never Throws Policy[2m > [22m[2mshould return UNASSIGNED_ROLE with failure reason on error
[22m[39m[RoleMapper] determineRoles called with: not-an-array
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mDefault Configuration[2m > [22m[2mshould map admin roles correctly
[22m[39m[RoleMapper] determineRoles called with: [ [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mDefault Configuration[2m > [22m[2mshould map user roles correctly
[22m[39m[RoleMapper] determineRoles called with: [ [32m'user'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'user'[39m ]
[RoleMapper] Primary role determined: user
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mDefault Configuration[2m > [22m[2mshould return default role when no matches
[22m[39m[RoleMapper] determineRoles called with: [ [32m'unknown-role'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'unknown-role'[39m ]
[RoleMapper] Primary role determined: guest
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mPriority-Based Role Assignment[2m > [22m[2mshould prioritize admin over user
[22m[39m[RoleMapper] determineRoles called with: [ [32m'user'[39m, [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'user'[39m, [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mPriority-Based Role Assignment[2m > [22m[2mshould prioritize user over guest
[22m[39m[RoleMapper] determineRoles called with: [ [32m'guest'[39m, [32m'user'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'guest'[39m, [32m'user'[39m ]
[RoleMapper] Primary role determined: user
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mPriority-Based Role Assignment[2m > [22m[2mshould follow priority order: admin > user > guest
[22m[39m[RoleMapper] determineRoles called with: [ [32m'guest'[39m, [32m'user'[39m, [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'guest'[39m, [32m'user'[39m, [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mCustom Role Mappings[2m > [22m[2mshould support custom role mappings
[22m[39m[RoleMapper] determineRoles called with: [ [32m'data_analyst'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: { analyst: [ [32m'data_analyst'[39m, [32m'business_analyst'[39m ] },
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'data_analyst'[39m ]
[RoleMapper] Primary role determined: analyst
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/delegation/token-exchange.test.ts[2m > [22m[2mTokenExchangeService[2m > [22m[2mperformExchange()[2m > [22m[2mshould successfully exchange token
[22m[39m[TokenExchange] Making token exchange request to IDP: {
  tokenEndpoint: [32m'https://idp.example.com/token'[39m,
  audience: [32m'sql-delegation'[39m,
  clientId: [32m'test-client'[39m,
  subjectTokenLength: [33m14[39m
}
[TokenExchange] IDP response status: [90mundefined[39m
[TokenExchange] IDP response data: {
  hasAccessToken: [33mtrue[39m,
  tokenType: [32m'Bearer'[39m,
  expiresIn: [33m3600[39m,
  error: [90mundefined[39m,
  errorDescription: [90mundefined[39m
}
[TokenExchange] Token exchange SUCCESS - received delegation token

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mCustom Role Mappings[2m > [22m[2mshould prioritize standard roles over custom roles
[22m[39m[RoleMapper] determineRoles called with: [ [32m'data_analyst'[39m, [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: { analyst: [ [32m'data_analyst'[39m ] },
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'data_analyst'[39m, [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: [ [32m'analyst'[39m ]

[90mstdout[2m | tests/unit/delegation/token-exchange.test.ts[2m > [22m[2mTokenExchangeService[2m > [22m[2mperformExchange()[2m > [22m[2mshould handle IDP error responses
[22m[39m[TokenExchange] Making token exchange request to IDP: {
  tokenEndpoint: [32m'https://idp.example.com/token'[39m,
  audience: [32m'sql-delegation'[39m,
  clientId: [32m'test-client'[39m,
  subjectTokenLength: [33m13[39m
}
[TokenExchange] IDP response status: [33m400[39m
[TokenExchange] IDP response data: {
  hasAccessToken: [33mfalse[39m,
  tokenType: [90mundefined[39m,
  expiresIn: [90mundefined[39m,
  error: [32m'invalid_grant'[39m,
  errorDescription: [32m'The provided authorization grant is invalid'[39m
}

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mCustom Role Mappings[2m > [22m[2mshould include custom roles in customRoles array
[22m[39m[RoleMapper] determineRoles called with: [ [32m'admin'[39m, [32m'data_analyst'[39m, [32m'dev'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: { analyst: [ [32m'data_analyst'[39m ], developer: [ [32m'dev'[39m ] },
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m, [32m'data_analyst'[39m, [32m'dev'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: [ [32m'analyst'[39m, [32m'developer'[39m ]

[90mstdout[2m | tests/unit/delegation/token-exchange.test.ts[2m > [22m[2mTokenExchangeService[2m > [22m[2mperformExchange()[2m > [22m[2mshould handle network errors
[22m[39m[TokenExchange] Making token exchange request to IDP: {
  tokenEndpoint: [32m'https://idp.example.com/token'[39m,
  audience: [32m'sql-delegation'[39m,
  clientId: [32m'test-client'[39m,
  subjectTokenLength: [33m14[39m
}

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mCustom Role Mappings[2m > [22m[2mshould not duplicate primary role in customRoles
[22m[39m[RoleMapper] determineRoles called with: [ [32m'data_analyst'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: { analyst: [ [32m'data_analyst'[39m ] },
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'data_analyst'[39m ]
[RoleMapper] Primary role determined: analyst
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/delegation/token-exchange.test.ts[2m > [22m[2mTokenExchangeService[2m > [22m[2mperformExchange()[2m > [22m[2mshould send correct RFC 8693 request body
[22m[39m[TokenExchange] Making token exchange request to IDP: {
  tokenEndpoint: [32m'https://idp.example.com/token'[39m,
  audience: [32m'sql-delegation'[39m,
  clientId: [32m'test-client'[39m,
  subjectTokenLength: [33m14[39m
}
[TokenExchange] IDP response status: [90mundefined[39m
[TokenExchange] IDP response data: {
  hasAccessToken: [33mtrue[39m,
  tokenType: [90mundefined[39m,
  expiresIn: [90mundefined[39m,
  error: [90mundefined[39m,
  errorDescription: [90mundefined[39m
}
[TokenExchange] Token exchange SUCCESS - received delegation token

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mEdge Cases[2m > [22m[2mshould handle empty roles array
[22m[39m[RoleMapper] determineRoles called with: []
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: []
[RoleMapper] No valid roles, using default: guest

[90mstdout[2m | tests/unit/delegation/token-exchange.test.ts[2m > [22m[2mTokenExchangeService[2m > [22m[2mAudit Logging[2m > [22m[2mshould work without audit service (Null Object Pattern)
[22m[39m[TokenExchange] Making token exchange request to IDP: {
  tokenEndpoint: [32m'https://idp.example.com/token'[39m,
  audience: [32m'sql-delegation'[39m,
  clientId: [32m'test-client'[39m,
  subjectTokenLength: [33m14[39m
}
[TokenExchange] IDP response status: [90mundefined[39m
[TokenExchange] IDP response data: {
  hasAccessToken: [33mtrue[39m,
  tokenType: [90mundefined[39m,
  expiresIn: [90mundefined[39m,
  error: [90mundefined[39m,
  errorDescription: [90mundefined[39m
}
[TokenExchange] Token exchange SUCCESS - received delegation token

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mEdge Cases[2m > [22m[2mshould filter out null/undefined values
[22m[39m[RoleMapper] determineRoles called with: [ [1mnull[22m, [32m'admin'[39m, [90mundefined[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/delegation/token-exchange.test.ts[2m > [22m[2mTokenExchangeService[2m > [22m[2mAudit Logging[2m > [22m[2mshould not crash if audit service log fails
[22m[39m[TokenExchange] Making token exchange request to IDP: {
  tokenEndpoint: [32m'https://idp.example.com/token'[39m,
  audience: [32m'sql-delegation'[39m,
  clientId: [32m'test-client'[39m,
  subjectTokenLength: [33m14[39m
}
[TokenExchange] IDP response status: [90mundefined[39m
[TokenExchange] IDP response data: {
  hasAccessToken: [33mtrue[39m,
  tokenType: [90mundefined[39m,
  expiresIn: [90mundefined[39m,
  error: [90mundefined[39m,
  errorDescription: [90mundefined[39m
}
[TokenExchange] Token exchange SUCCESS - received delegation token

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mEdge Cases[2m > [22m[2mshould filter out empty strings
[22m[39m[RoleMapper] determineRoles called with: [ [32m''[39m, [32m'admin'[39m, [32m''[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []

[90mstderr[2m | tests/unit/delegation/token-exchange.test.ts[2m > [22m[2mTokenExchangeService[2m > [22m[2mAudit Logging[2m > [22m[2mshould not crash if audit service log fails
[22m[39mFailed to log audit entry: Error: Audit failed
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\token-exchange.test.ts:324:50
    at [90mfile:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:146:14
    at [90mfile:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:533:11
    at runWithTimeout [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:39:7[90m)[39m
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1056:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runFiles [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1262:5[90m)[39m

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mEdge Cases[2m > [22m[2mshould handle roles with special characters
[22m[39m[RoleMapper] determineRoles called with: [ [32m'role:with:colons'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: { [32m'special-role'[39m: [ [32m'role:with:colons'[39m, [32m'role/with/slashes'[39m ] },
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'role:with:colons'[39m ]
[RoleMapper] Primary role determined: special-role
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/delegation/token-exchange.test.ts[2m > [22m[2mTokenExchangeService[2m > [22m[2mAudit Logging[2m > [22m[2mshould log success with metadata
[22m[39m[TokenExchange] Making token exchange request to IDP: {
  tokenEndpoint: [32m'https://idp.example.com/token'[39m,
  audience: [32m'test-audience'[39m,
  clientId: [32m'test-client'[39m,
  subjectTokenLength: [33m14[39m
}
[TokenExchange] IDP response status: [90mundefined[39m
[TokenExchange] IDP response data: {
  hasAccessToken: [33mtrue[39m,
  tokenType: [32m'Bearer'[39m,
  expiresIn: [33m3600[39m,
  error: [90mundefined[39m,
  errorDescription: [90mundefined[39m
}
[TokenExchange] Token exchange SUCCESS - received delegation token

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mConfiguration Updates[2m > [22m[2mshould allow configuration updates
[22m[39m[RoleMapper] determineRoles called with: [ [32m'superadmin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'superadmin'[39m, [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'superadmin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []

 [32mâœ“[39m tests/unit/delegation/token-exchange.test.ts [2m([22m[2m18 tests[22m[2m)[22m[90m 140[2mms[22m[39m
[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mDefault Role Behavior[2m > [22m[2mshould use custom default role when configured
[22m[39m[RoleMapper] determineRoles called with: [ [32m'unknown'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'anonymous'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'unknown'[39m ]
[RoleMapper] Primary role determined: anonymous
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mDefault Role Behavior[2m > [22m[2mshould use ROLE_GUEST as default when not configured
[22m[39m[RoleMapper] determineRoles called with: [ [32m'unknown'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'unknown'[39m ]
[RoleMapper] Primary role determined: guest
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mComplex Scenarios[2m > [22m[2mshould handle multiple custom roles correctly
[22m[39m[RoleMapper] determineRoles called with: [ [32m'data_analyst'[39m, [32m'frontend_dev'[39m, [32m'ui_designer'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {
    analyst: [ [32m'data_analyst'[39m, [32m'business_analyst'[39m ],
    developer: [ [32m'frontend_dev'[39m, [32m'backend_dev'[39m ],
    designer: [ [32m'ui_designer'[39m, [32m'ux_designer'[39m ]
  },
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'data_analyst'[39m, [32m'frontend_dev'[39m, [32m'ui_designer'[39m ]
[RoleMapper] Primary role determined: analyst
[RoleMapper] Custom roles determined: [ [32m'developer'[39m, [32m'designer'[39m ]

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mComplex Scenarios[2m > [22m[2mshould handle case-sensitive role names
[22m[39m[RoleMapper] determineRoles called with: [ [32m'Admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'Admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'Admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []
[RoleMapper] determineRoles called with: [ [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'Admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m ]
[RoleMapper] Primary role determined: guest
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mValidation Results[2m > [22m[2mshould set mappingFailed to false on success
[22m[39m[RoleMapper] determineRoles called with: [ [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mValidation Results[2m > [22m[2mshould set mappingFailed to true on error
[22m[39m[RoleMapper] determineRoles called with: [1mnull[22m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mValidation Results[2m > [22m[2mshould include failure reason when mapping fails
[22m[39m[RoleMapper] determineRoles called with: invalid
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mUnmapped Role Rejection (rejectUnmappedRoles)[2m > [22m[2mshould use defaultRole when rejectUnmappedRoles=false (default)
[22m[39m[RoleMapper] determineRoles called with: [ [32m'unknown-role'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'unknown-role'[39m ]
[RoleMapper] Primary role determined: guest
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mUnmapped Role Rejection (rejectUnmappedRoles)[2m > [22m[2mshould reject authentication when rejectUnmappedRoles=true
[22m[39m[RoleMapper] determineRoles called with: [ [32m'unknown-role'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'unknown-role'[39m ]
[RoleMapper] Primary role determined: unassigned
[RoleMapper] Rejecting authentication - unmapped roles: [ [32m'unknown-role'[39m ]

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mUnmapped Role Rejection (rejectUnmappedRoles)[2m > [22m[2mshould accept authentication when role matches even if rejectUnmappedRoles=true
[22m[39m[RoleMapper] determineRoles called with: [ [32m'user'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'user'[39m ]
[RoleMapper] Primary role determined: user
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mUnmapped Role Rejection (rejectUnmappedRoles)[2m > [22m[2mshould reject multiple unmapped roles with detailed message
[22m[39m[RoleMapper] determineRoles called with: [ [32m'role1'[39m, [32m'role2'[39m, [32m'role3'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'role1'[39m, [32m'role2'[39m, [32m'role3'[39m ]
[RoleMapper] Primary role determined: unassigned
[RoleMapper] Rejecting authentication - unmapped roles: [ [32m'role1'[39m, [32m'role2'[39m, [32m'role3'[39m ]

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mUnmapped Role Rejection (rejectUnmappedRoles)[2m > [22m[2mshould use defaultRole when rejectUnmappedRoles is not configured
[22m[39m[RoleMapper] determineRoles called with: [ [32m'unknown'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'unknown'[39m ]
[RoleMapper] Primary role determined: guest
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mUnmapped Role Rejection (rejectUnmappedRoles)[2m > [22m[2mshould work with custom roles when rejectUnmappedRoles=true
[22m[39m[RoleMapper] determineRoles called with: [ [32m'data_analyst'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: { analyst: [ [32m'data_analyst'[39m ] },
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'data_analyst'[39m ]
[RoleMapper] Primary role determined: analyst
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mUnmapped Role Rejection (rejectUnmappedRoles)[2m > [22m[2mshould reject when none of multiple roles match and rejectUnmappedRoles=true
[22m[39m[RoleMapper] determineRoles called with: [ [32m'guest'[39m, [32m'viewer'[39m, [32m'reader'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'guest'[39m, [32m'viewer'[39m, [32m'reader'[39m ]
[RoleMapper] Primary role determined: unassigned
[RoleMapper] Rejecting authentication - unmapped roles: [ [32m'guest'[39m, [32m'viewer'[39m, [32m'reader'[39m ]

[90mstdout[2m | tests/unit/core/role-mapper.test.ts[2m > [22m[2mRoleMapper[2m > [22m[2mUnmapped Role Rejection (rejectUnmappedRoles)[2m > [22m[2mshould accept if ANY role matches even when some roles are unmapped
[22m[39m[RoleMapper] determineRoles called with: [ [32m'unknown1'[39m, [32m'user'[39m, [32m'unknown2'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'unknown1'[39m, [32m'user'[39m, [32m'unknown2'[39m ]
[RoleMapper] Primary role determined: user
[RoleMapper] Custom roles determined: []

 [32mâœ“[39m tests/unit/core/role-mapper.test.ts [2m([22m[2m35 tests[22m[2m)[22m[90m 119[2mms[22m[39m
[90mstdout[2m | tests/unit/mcp/tools/user-info.test.ts[2m > [22m[2muser-info Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould return basic user info without claims
[22m[39m[user-info] Session object: {
  userId: [32m'user123'[39m,
  username: [32m'testuser'[39m,
  role: [32m'user'[39m,
  permissions: [ [32m'sql:query'[39m, [32m'sql:procedure'[39m ],
  _version: [33m1[39m,
  rejected: [33mfalse[39m,
  claims: {
    iss: [32m'https://auth.example.com'[39m,
    sub: [32m'user123'[39m,
    aud: [32m'mcp-server'[39m,
    exp: [33m1762737299[39m,
    iat: [33m1762733699[39m,
    jti: [32m'token-id-12345'[39m,
    azp: [32m'mcp-client'[39m
  }
}
[user-info] Session keys: [
  [32m'userId'[39m,
  [32m'username'[39m,
  [32m'role'[39m,
  [32m'permissions'[39m,
  [32m'_version'[39m,
  [32m'rejected'[39m,
  [32m'claims'[39m
]

[90mstdout[2m | tests/unit/mcp/tools/user-info.test.ts[2m > [22m[2muser-info Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould include claims when includeClaims=true
[22m[39m[user-info] Session object: {
  userId: [32m'user123'[39m,
  username: [32m'testuser'[39m,
  role: [32m'user'[39m,
  permissions: [ [32m'sql:query'[39m, [32m'sql:procedure'[39m ],
  _version: [33m1[39m,
  rejected: [33mfalse[39m,
  claims: {
    iss: [32m'https://auth.example.com'[39m,
    sub: [32m'user123'[39m,
    aud: [32m'mcp-server'[39m,
    exp: [33m1762737299[39m,
    iat: [33m1762733699[39m,
    jti: [32m'token-id-12345'[39m,
    azp: [32m'mcp-client'[39m
  }
}
[user-info] Session keys: [
  [32m'userId'[39m,
  [32m'username'[39m,
  [32m'role'[39m,
  [32m'permissions'[39m,
  [32m'_version'[39m,
  [32m'rejected'[39m,
  [32m'claims'[39m
]

[90mstdout[2m | tests/unit/mcp/tools/user-info.test.ts[2m > [22m[2muser-info Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould sanitize sensitive claims (jti, azp)
[22m[39m[user-info] Session object: {
  userId: [32m'user123'[39m,
  username: [32m'testuser'[39m,
  role: [32m'user'[39m,
  permissions: [ [32m'sql:query'[39m, [32m'sql:procedure'[39m ],
  _version: [33m1[39m,
  rejected: [33mfalse[39m,
  claims: {
    iss: [32m'https://auth.example.com'[39m,
    sub: [32m'user123'[39m,
    aud: [32m'mcp-server'[39m,
    exp: [33m1762737299[39m,
    iat: [33m1762733699[39m,
    jti: [32m'token-id-12345'[39m,
    azp: [32m'mcp-client'[39m
  }
}
[user-info] Session keys: [
  [32m'userId'[39m,
  [32m'username'[39m,
  [32m'role'[39m,
  [32m'permissions'[39m,
  [32m'_version'[39m,
  [32m'rejected'[39m,
  [32m'claims'[39m
]

[90mstdout[2m | tests/unit/mcp/tools/user-info.test.ts[2m > [22m[2muser-info Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould include legacyUsername if present
[22m[39m[user-info] Session object: {
  userId: [32m'user123'[39m,
  username: [32m'testuser'[39m,
  role: [32m'user'[39m,
  permissions: [ [32m'sql:query'[39m, [32m'sql:procedure'[39m ],
  _version: [33m1[39m,
  rejected: [33mfalse[39m,
  claims: {
    iss: [32m'https://auth.example.com'[39m,
    sub: [32m'user123'[39m,
    aud: [32m'mcp-server'[39m,
    exp: [33m1762737299[39m,
    iat: [33m1762733699[39m,
    jti: [32m'token-id-12345'[39m,
    azp: [32m'mcp-client'[39m
  },
  legacyUsername: [32m'DOMAIN\\legacy_user'[39m
}
[user-info] Session keys: [
  [32m'userId'[39m,
  [32m'username'[39m,
  [32m'role'[39m,
  [32m'permissions'[39m,
  [32m'_version'[39m,
  [32m'rejected'[39m,
  [32m'claims'[39m,
  [32m'legacyUsername'[39m
]

[90mstdout[2m | tests/unit/mcp/tools/user-info.test.ts[2m > [22m[2muser-info Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould include customRoles if present
[22m[39m[user-info] Session object: {
  userId: [32m'user123'[39m,
  username: [32m'testuser'[39m,
  role: [32m'user'[39m,
  permissions: [ [32m'sql:query'[39m, [32m'sql:procedure'[39m ],
  _version: [33m1[39m,
  rejected: [33mfalse[39m,
  claims: {
    iss: [32m'https://auth.example.com'[39m,
    sub: [32m'user123'[39m,
    aud: [32m'mcp-server'[39m,
    exp: [33m1762737299[39m,
    iat: [33m1762733699[39m,
    jti: [32m'token-id-12345'[39m,
    azp: [32m'mcp-client'[39m
  },
  customRoles: [ [32m'developer'[39m, [32m'analyst'[39m ]
}
[user-info] Session keys: [
  [32m'userId'[39m,
  [32m'username'[39m,
  [32m'role'[39m,
  [32m'permissions'[39m,
  [32m'_version'[39m,
  [32m'rejected'[39m,
  [32m'claims'[39m,
  [32m'customRoles'[39m
]

[90mstdout[2m | tests/unit/mcp/tools/user-info.test.ts[2m > [22m[2muser-info Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould include scopes if present
[22m[39m[user-info] Session object: {
  userId: [32m'user123'[39m,
  username: [32m'testuser'[39m,
  role: [32m'user'[39m,
  permissions: [ [32m'sql:query'[39m, [32m'sql:procedure'[39m ],
  _version: [33m1[39m,
  rejected: [33mfalse[39m,
  claims: {
    iss: [32m'https://auth.example.com'[39m,
    sub: [32m'user123'[39m,
    aud: [32m'mcp-server'[39m,
    exp: [33m1762737299[39m,
    iat: [33m1762733699[39m,
    jti: [32m'token-id-12345'[39m,
    azp: [32m'mcp-client'[39m
  },
  scopes: [ [32m'read'[39m, [32m'write'[39m ]
}
[user-info] Session keys: [
  [32m'userId'[39m,
  [32m'username'[39m,
  [32m'role'[39m,
  [32m'permissions'[39m,
  [32m'_version'[39m,
  [32m'rejected'[39m,
  [32m'claims'[39m,
  [32m'scopes'[39m
]

[90mstdout[2m | tests/unit/mcp/tools/user-info.test.ts[2m > [22m[2muser-info Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould not include empty optional fields
[22m[39m[user-info] Session object: {
  userId: [32m'user123'[39m,
  username: [32m'testuser'[39m,
  role: [32m'user'[39m,
  permissions: [ [32m'sql:query'[39m ],
  _version: [33m1[39m,
  rejected: [33mfalse[39m,
  claims: {},
  customRoles: [],
  scopes: []
}
[user-info] Session keys: [
  [32m'userId'[39m,
  [32m'username'[39m,
  [32m'role'[39m,
  [32m'permissions'[39m,
  [32m'_version'[39m,
  [32m'rejected'[39m,
  [32m'claims'[39m,
  [32m'customRoles'[39m,
  [32m'scopes'[39m
]

[90mstdout[2m | tests/unit/mcp/tools/user-info.test.ts[2m > [22m[2muser-info Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould use default includeClaims=false when not specified
[22m[39m[user-info] Session object: {
  userId: [32m'user123'[39m,
  username: [32m'testuser'[39m,
  role: [32m'user'[39m,
  permissions: [ [32m'sql:query'[39m, [32m'sql:procedure'[39m ],
  _version: [33m1[39m,
  rejected: [33mfalse[39m,
  claims: {
    iss: [32m'https://auth.example.com'[39m,
    sub: [32m'user123'[39m,
    aud: [32m'mcp-server'[39m,
    exp: [33m1762737299[39m,
    iat: [33m1762733699[39m,
    jti: [32m'token-id-12345'[39m,
    azp: [32m'mcp-client'[39m
  }
}
[user-info] Session keys: [
  [32m'userId'[39m,
  [32m'username'[39m,
  [32m'role'[39m,
  [32m'permissions'[39m,
  [32m'_version'[39m,
  [32m'rejected'[39m,
  [32m'claims'[39m
]

[90mstdout[2m | tests/unit/mcp/tools/user-info.test.ts[2m > [22m[2muser-info Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould handle sessions without claims gracefully
[22m[39m[user-info] Session object: {
  userId: [32m'user123'[39m,
  username: [32m'testuser'[39m,
  role: [32m'user'[39m,
  permissions: [ [32m'sql:query'[39m, [32m'sql:procedure'[39m ],
  _version: [33m1[39m,
  rejected: [33mfalse[39m,
  claims: [90mundefined[39m
}
[user-info] Session keys: [
  [32m'userId'[39m,
  [32m'username'[39m,
  [32m'role'[39m,
  [32m'permissions'[39m,
  [32m'_version'[39m,
  [32m'rejected'[39m,
  [32m'claims'[39m
]

[90mstdout[2m | tests/unit/mcp/tools/user-info.test.ts[2m > [22m[2muser-info Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould return LLMSuccessResponse on success (GAP #5)
[22m[39m[user-info] Session object: {
  userId: [32m'user123'[39m,
  username: [32m'testuser'[39m,
  role: [32m'user'[39m,
  permissions: [ [32m'sql:query'[39m, [32m'sql:procedure'[39m ],
  _version: [33m1[39m,
  rejected: [33mfalse[39m,
  claims: {
    iss: [32m'https://auth.example.com'[39m,
    sub: [32m'user123'[39m,
    aud: [32m'mcp-server'[39m,
    exp: [33m1762737299[39m,
    iat: [33m1762733699[39m,
    jti: [32m'token-id-12345'[39m,
    azp: [32m'mcp-client'[39m
  }
}
[user-info] Session keys: [
  [32m'userId'[39m,
  [32m'username'[39m,
  [32m'role'[39m,
  [32m'permissions'[39m,
  [32m'_version'[39m,
  [32m'rejected'[39m,
  [32m'claims'[39m
]

 [32mâœ“[39m tests/unit/mcp/tools/user-info.test.ts [2m([22m[2m20 tests[22m[2m)[22m[90m 57[2mms[22m[39m
 [32mâœ“[39m tests/unit/core/jwt-validator.test.ts [2m([22m[2m30 tests[22m[2m)[22m[90m 156[2mms[22m[39m
[90mstderr[2m | tests/unit/mcp/tools/health-check.test.ts[2m > [22m[2mhealth-check Tool[2m > [22m[2mHandler Execution[2m > [22m[2mshould handle errors gracefully
[22m[39m
[ERROR-HANDLER] Tool execution error in health-check
[ERROR-HANDLER] Error: Error: Health check failed
    at Object.healthCheck [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\mcp\tools\health-check.test.ts:281:17[90m)[39m
    at Object.handler [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39msrc\mcp\tools\health-check.ts:107:36[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\mcp\tools\health-check.test.ts:296:34
    at [90mfile:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:146:14
    at [90mfile:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:533:11
    at runWithTimeout [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:39:7[90m)[39m
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1056:17[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
[ERROR-HANDLER] Error type: Error
[ERROR-HANDLER] Message: Health check failed
[ERROR-HANDLER] Stack: Error: Health check failed
    at Object.healthCheck (c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\tests\unit\mcp\tools\health-check.test.ts:281:17)
    at Object.handler (c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\src\mcp\tools\health-check.ts:107:36)
    at c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\tests\unit\mcp\tools\health-check.test.ts:296:34
    at file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:146:14
    at file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:533:11
    at runWithTimeout (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:39:7)
    at runTest (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1056:17)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)
[ERROR-HANDLER] Params: { service: [32m'sql'[39m }
[ERROR-HANDLER] User: user1

 [32mâœ“[39m tests/unit/config/migrate.test.ts [2m([22m[2m8 tests[22m[2m)[22m[90m 51[2mms[22m[39m
 [32mâœ“[39m tests/integration/phase2-corecontext-injection.test.ts [2m([22m[2m8 tests[22m[2m)[22m[90m 43[2mms[22m[39m
[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mAuthentication Flow (Mocked)[2m > [22m[2mshould orchestrate JWT validation, role mapping, and session creation
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [ [32m'admin'[39m ],
  rolesType: [32m'object'[39m,
  isArray: [33mtrue[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [ [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []
[AuthenticationService] RoleMapper result: { primaryRole: [32m'admin'[39m, customRoles: [], mappingFailed: [33mfalse[39m }
[AuthenticationService] Session created: {
  sessionId: [32m'db5ee7b3-e021-466a-89d6-6160a7c23059'[39m,
  userId: [32m'user123'[39m,
  role: [32m'admin'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

 [32mâœ“[39m tests/unit/mcp/tools/health-check.test.ts [2m([22m[2m18 tests[22m[2m)[22m[90m 97[2mms[22m[39m
[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mAuthentication Flow (Mocked)[2m > [22m[2mshould return rejected session for UNASSIGNED_ROLE without throwing
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [33mfalse[39m,
  rolesType: [32m'boolean'[39m,
  isArray: [33mfalse[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [33mfalse[39m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array
[AuthenticationService] RoleMapper result: {
  primaryRole: [32m'unassigned'[39m,
  customRoles: [],
  mappingFailed: [33mtrue[39m,
  failureReason: [32m'Invalid input: roles must be an array'[39m
}
[AuthenticationService] Session created: {
  sessionId: [32m'61bf24c7-8cba-4040-896c-c5185e040ab6'[39m,
  userId: [32m'user456'[39m,
  role: [32m'unassigned'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mCRITICAL: Rejection Policy (GAP #1)[2m > [22m[2mshould NOT throw on UNASSIGNED_ROLE, return rejected=true instead
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [1mnull[22m,
  rolesType: [32m'object'[39m,
  isArray: [33mfalse[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [1mnull[22m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array
[AuthenticationService] RoleMapper result: {
  primaryRole: [32m'unassigned'[39m,
  customRoles: [],
  mappingFailed: [33mtrue[39m,
  failureReason: [32m'Invalid input: roles must be an array'[39m
}
[AuthenticationService] Session created: {
  sessionId: [32m'e1883ea1-ec25-4ece-8690-ac1caac3dc12'[39m,
  userId: [32m'user'[39m,
  role: [32m'unassigned'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

 [32mâœ“[39m tests/unit/config/schemas.test.ts [2m([22m[2m17 tests[22m[2m)[22m[90m 71[2mms[22m[39m
[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mCRITICAL: Rejection Policy (GAP #1)[2m > [22m[2mshould include rejection reason in result
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [1mnull[22m,
  rolesType: [32m'object'[39m,
  isArray: [33mfalse[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [1mnull[22m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array
[AuthenticationService] RoleMapper result: {
  primaryRole: [32m'unassigned'[39m,
  customRoles: [],
  mappingFailed: [33mtrue[39m,
  failureReason: [32m'Invalid input: roles must be an array'[39m
}
[AuthenticationService] Session created: {
  sessionId: [32m'bf19182d-eebf-4a83-aea6-3b3ffed287d2'[39m,
  userId: [32m'user'[39m,
  role: [32m'unassigned'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mCRITICAL: Audit Source Field (GAP #3)[2m > [22m[2mshould include source="auth:service" in audit entry on success
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [ [32m'admin'[39m ],
  rolesType: [32m'object'[39m,
  isArray: [33mtrue[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [ [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []
[AuthenticationService] RoleMapper result: { primaryRole: [32m'admin'[39m, customRoles: [], mappingFailed: [33mfalse[39m }
[AuthenticationService] Session created: {
  sessionId: [32m'28034e1a-2afe-4ddb-92e8-974875bd4c60'[39m,
  userId: [32m'user123'[39m,
  role: [32m'admin'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mCRITICAL: Audit Source Field (GAP #3)[2m > [22m[2mshould include source="auth:service" in audit entry on rejection
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [33m123[39m,
  rolesType: [32m'number'[39m,
  isArray: [33mfalse[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [33m123[39m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array
[AuthenticationService] RoleMapper result: {
  primaryRole: [32m'unassigned'[39m,
  customRoles: [],
  mappingFailed: [33mtrue[39m,
  failureReason: [32m'Invalid input: roles must be an array'[39m
}
[AuthenticationService] Session created: {
  sessionId: [32m'7948688b-0507-4446-8f6e-c88aced4035d'[39m,
  userId: [32m'user456'[39m,
  role: [32m'unassigned'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mAudit Entry Validation[2m > [22m[2mshould return audit entry in successful result
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [ [32m'user'[39m ],
  rolesType: [32m'object'[39m,
  isArray: [33mtrue[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [ [32m'user'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'user'[39m ]
[RoleMapper] Primary role determined: user
[RoleMapper] Custom roles determined: []
[AuthenticationService] RoleMapper result: { primaryRole: [32m'user'[39m, customRoles: [], mappingFailed: [33mfalse[39m }
[AuthenticationService] Session created: {
  sessionId: [32m'40758aaf-1bb8-44fb-991f-048f23ecb876'[39m,
  userId: [32m'user123'[39m,
  role: [32m'user'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mAudit Entry Validation[2m > [22m[2mshould include metadata in audit entry
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [ [32m'admin'[39m ],
  rolesType: [32m'object'[39m,
  isArray: [33mtrue[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [ [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []
[AuthenticationService] RoleMapper result: { primaryRole: [32m'admin'[39m, customRoles: [], mappingFailed: [33mfalse[39m }
[AuthenticationService] Session created: {
  sessionId: [32m'a0962531-3123-4f54-82eb-00fe578ce2b4'[39m,
  userId: [32m'user123'[39m,
  role: [32m'admin'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mRole Array Extraction[2m > [22m[2mshould extract roles from string in claims
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [32m'admin'[39m,
  rolesType: [32m'string'[39m,
  isArray: [33mfalse[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [ [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []
[AuthenticationService] RoleMapper result: { primaryRole: [32m'admin'[39m, customRoles: [], mappingFailed: [33mfalse[39m }
[AuthenticationService] Session created: {
  sessionId: [32m'09a29fff-9a57-45ba-9366-e9388ffe22f0'[39m,
  userId: [32m'user123'[39m,
  role: [32m'admin'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mRole Array Extraction[2m > [22m[2mshould handle array of roles in claims
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [ [32m'user'[39m, [32m'admin'[39m ],
  rolesType: [32m'object'[39m,
  isArray: [33mtrue[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [ [32m'user'[39m, [32m'admin'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'user'[39m, [32m'admin'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []
[AuthenticationService] RoleMapper result: { primaryRole: [32m'admin'[39m, customRoles: [], mappingFailed: [33mfalse[39m }
[AuthenticationService] Session created: {
  sessionId: [32m'1719601e-a08a-4f77-b7ca-a38dc3dbec5b'[39m,
  userId: [32m'user123'[39m,
  role: [32m'admin'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

[90mstdout[2m | tests/unit/core/authentication-service.test.ts[2m > [22m[2mAuthenticationService[2m > [22m[2mRole Array Extraction[2m > [22m[2mshould handle missing roles claim
[22m[39m[AuthenticationService] Requestor JWT validated: { userId: [90mundefined[39m, issuer: [90mundefined[39m }
[AuthenticationService] Role extraction: {
  idpName: [32m'requestor-jwt'[39m,
  rolesClaimPath: [32m'user_roles'[39m,
  rolesFromClaims: [90mundefined[39m,
  rolesType: [32m'undefined'[39m,
  isArray: [33mfalse[39m,
  sourceToken: [32m'requestor JWT'[39m
}
[RoleMapper] determineRoles called with: [90mundefined[39m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [ [32m'guest'[39m ],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array
[AuthenticationService] RoleMapper result: {
  primaryRole: [32m'unassigned'[39m,
  customRoles: [],
  mappingFailed: [33mtrue[39m,
  failureReason: [32m'Invalid input: roles must be an array'[39m
}
[AuthenticationService] Session created: {
  sessionId: [32m'a3b773a1-a5cd-4136-8b51-95d0d63ed3ce'[39m,
  userId: [32m'user123'[39m,
  role: [32m'unassigned'[39m,
  customRoles: [],
  hasRequestorJWT: [33mtrue[39m
}

 [32mâœ“[39m tests/unit/core/authentication-service.test.ts [2m([22m[2m20 tests[22m[2m)[22m[90m 110[2mms[22m[39m
 [32mâœ“[39m tests/unit/delegation/registry.test.ts [2m([22m[2m38 tests[22m[2m)[22m[90m 133[2mms[22m[39m
 [32mâœ“[39m src/mcp/__tests__/authorization.test.ts [2m([22m[2m32 tests[22m[2m)[22m[90m 62[2mms[22m[39m
[90mstdout[2m | tests/unit/mcp/middleware.test.ts[2m > [22m[2mMCP Middleware[2m > [22m[2mMCPAuthMiddleware[2m > [22m[2mToken Extraction[2m > [22m[2mshould extract Bearer token from Authorization header
[22m[39m[MCPAuthMiddleware] Authenticating request: { method: [90mundefined[39m, path: [90mundefined[39m, hasAuthHeader: [33mtrue[39m }
[MCPAuthMiddleware] âœ“ Token extracted, validating...
[MCPAuthMiddleware] Auth result: {
  rejected: [33mfalse[39m,
  sessionRejected: [33mfalse[39m,
  role: [32m'user'[39m,
  customRoles: [],
  userId: [32m'user123'[39m
}
[MCPAuthMiddleware] âœ“ Authentication successful

[90mstdout[2m | tests/unit/mcp/middleware.test.ts[2m > [22m[2mMCP Middleware[2m > [22m[2mMCPAuthMiddleware[2m > [22m[2mToken Extraction[2m > [22m[2mshould handle Authorization header (capital A)
[22m[39m[MCPAuthMiddleware] Authenticating request: { method: [90mundefined[39m, path: [90mundefined[39m, hasAuthHeader: [33mtrue[39m }
[MCPAuthMiddleware] âœ“ Token extracted, validating...
[MCPAuthMiddleware] Auth result: {
  rejected: [33mfalse[39m,
  sessionRejected: [33mfalse[39m,
  role: [32m'user'[39m,
  customRoles: [90mundefined[39m,
  userId: [32m'user123'[39m
}
[MCPAuthMiddleware] âœ“ Authentication successful

[90mstdout[2m | tests/unit/mcp/middleware.test.ts[2m > [22m[2mMCP Middleware[2m > [22m[2mMCPAuthMiddleware[2m > [22m[2mToken Extraction[2m > [22m[2mshould return error if Authorization header is missing
[22m[39m[MCPAuthMiddleware] Authenticating request: { method: [90mundefined[39m, path: [90mundefined[39m, hasAuthHeader: [33mfalse[39m }
[MCPAuthMiddleware] âŒ No Bearer token found
[MCPAuthMiddleware] âŒ Authentication error (statusCode: 401): Unauthorized: Missing Authorization header with Bearer token

[90mstdout[2m | tests/unit/mcp/middleware.test.ts[2m > [22m[2mMCP Middleware[2m > [22m[2mMCPAuthMiddleware[2m > [22m[2mToken Extraction[2m > [22m[2mshould return error if Bearer token format is invalid
[22m[39m[MCPAuthMiddleware] Authenticating request: { method: [90mundefined[39m, path: [90mundefined[39m, hasAuthHeader: [33mtrue[39m }
[MCPAuthMiddleware] âŒ No Bearer token found
[MCPAuthMiddleware] âŒ Authentication error (statusCode: 401): Unauthorized: Missing Authorization header with Bearer token

[90mstdout[2m | tests/unit/mcp/middleware.test.ts[2m > [22m[2mMCP Middleware[2m > [22m[2mMCPAuthMiddleware[2m > [22m[2mDual Rejection Checks (GAP #1)[2m > [22m[2mshould reject if authResult.rejected is true
[22m[39m[MCPAuthMiddleware] Authenticating request: { method: [90mundefined[39m, path: [90mundefined[39m, hasAuthHeader: [33mtrue[39m }
[MCPAuthMiddleware] âœ“ Token extracted, validating...
[MCPAuthMiddleware] Auth result: {
  rejected: [33mtrue[39m,
  sessionRejected: [33mtrue[39m,
  role: [32m'UNASSIGNED_ROLE'[39m,
  customRoles: [90mundefined[39m,
  userId: [32m'user123'[39m
}
[MCPAuthMiddleware] âŒ Auth result rejected: [90mundefined[39m
[MCPAuthMiddleware] âŒ Authentication error (statusCode: 403): Unauthorized: User has no valid roles assigned

[90mstdout[2m | tests/unit/mcp/middleware.test.ts[2m > [22m[2mMCP Middleware[2m > [22m[2mMCPAuthMiddleware[2m > [22m[2mDual Rejection Checks (GAP #1)[2m > [22m[2mshould reject if session.rejected is true (GAP #1)
[22m[39m[MCPAuthMiddleware] Authenticating request: { method: [90mundefined[39m, path: [90mundefined[39m, hasAuthHeader: [33mtrue[39m }
[MCPAuthMiddleware] âœ“ Token extracted, validating...
[MCPAuthMiddleware] Auth result: {
  rejected: [33mfalse[39m,
  sessionRejected: [33mtrue[39m,
  role: [32m'UNASSIGNED_ROLE'[39m,
  customRoles: [90mundefined[39m,
  userId: [32m'user123'[39m
}
[MCPAuthMiddleware] âŒ Session rejected - unassigned role
[MCPAuthMiddleware] âŒ Authentication error (statusCode: 403): Unauthorized: User has no valid roles assigned

[90mstdout[2m | tests/unit/mcp/middleware.test.ts[2m > [22m[2mMCP Middleware[2m > [22m[2mMCPAuthMiddleware[2m > [22m[2mDual Rejection Checks (GAP #1)[2m > [22m[2mshould accept if both checks pass
[22m[39m[MCPAuthMiddleware] Authenticating request: { method: [90mundefined[39m, path: [90mundefined[39m, hasAuthHeader: [33mtrue[39m }
[MCPAuthMiddleware] âœ“ Token extracted, validating...
[MCPAuthMiddleware] Auth result: {
  rejected: [33mfalse[39m,
  sessionRejected: [33mfalse[39m,
  role: [32m'user'[39m,
  customRoles: [90mundefined[39m,
  userId: [32m'user123'[39m
}
[MCPAuthMiddleware] âœ“ Authentication successful

 [32mâœ“[39m tests/unit/mcp/middleware.test.ts [2m([22m[2m14 tests[22m[2m)[22m[90m 67[2mms[22m[39m
 [32mâœ“[39m tests/unit/core/validators.test.ts [2m([22m[2m16 tests[22m[2m)[22m[90m 31[2mms[22m[39m
[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2minitialize()[2m > [22m[2mshould throw initialization error
[22m[39m
[KERBEROS-MODULE:kerberos] Initializing Kerberos delegation module
[KERBEROS-MODULE:kerberos] Configuration: {
  domainController: [32m'dc.company.com'[39m,
  realm: [32m'COMPANY.COM'[39m,
  servicePrincipalName: [32m'HTTP/webapp.company.com'[39m,
  kdc: [32m'kdc.company.com:88'[39m,
  enableS4U2Self: [33mtrue[39m,
  enableS4U2Proxy: [33mtrue[39m,
  allowedDelegationTargetsCount: [33m1[39m,
  ticketCacheEnabled: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Creating Kerberos client
[KERBEROS-MODULE:kerberos] Initializing ticket cache: { ttlSeconds: [33m3600[39m, renewThresholdSeconds: [33m300[39m }
[KERBEROS-MODULE:kerberos] Obtaining service ticket (TGT)

[KERBEROS-CLIENT] obtainServiceTicket() called
[KERBEROS-CLIENT] Service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] Service account: svc-mcp-server
[KERBEROS-CLIENT] Realm: COMPANY.COM
[KERBEROS-CLIENT] Domain Controller: dc.company.com
[KERBEROS-CLIENT] KDC: kdc.company.com:88
[KERBEROS-CLIENT] Password provided - attempting password authentication
[KERBEROS-CLIENT] NOTE: On Windows, password auth requires credentials in Windows Credential Manager
[KERBEROS-CLIENT] Initializing Kerberos client with node-kerberos library
[KERBEROS-CLIENT] Auth options: {
  principal: [32m'svc-mcp-server@COMPANY.COM'[39m,
  hasPassword: [33mtrue[39m,
  hasKeytab: [33mfalse[39m
}
[KERBEROS-CLIENT] Initializing client for service principal: HTTP/webapp.company.com@COMPANY.COM

[90mstderr[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2minitialize()[2m > [22m[2mshould throw initialization error
[22m[39m[KERBEROS-CLIENT] âœ— Failed to obtain service ticket: [Error: InitializeSecurityContext: No credentials are available in the security package
]
[KERBEROS-CLIENT] Error details: {
  message: [32m'InitializeSecurityContext: No credentials are available in the security package\r\n'[39m,
  stack: [32m'Error: InitializeSecurityContext: No credentials are available in the security package\r\n'[39m
}
[KERBEROS-MODULE:kerberos] âœ— Failed to obtain service ticket: Error: Failed to obtain service ticket: InitializeSecurityContext: No credentials are available in the security package

    at KerberosClient.obtainServiceTicket [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-client.ts:178:13[90m)[39m
    at KerberosDelegationModule.initialize [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:114:7[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\kerberos\kerberos-module.test.ts:60:7
    at [90mfile:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:533:5
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1056:11[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runFiles [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1262:5[90m)[39m
    at startTests [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1271:3[90m)[39m

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2minitialize()[2m > [22m[2mshould throw initialization error
[22m[39m[KERBEROS-CLIENT] âœ“ Kerberos client initialized
[KERBEROS-CLIENT] Obtaining TGT (Ticket Granting Ticket)

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2minitialize()[2m > [22m[2mshould fail when service ticket not obtained
[22m[39m
[KERBEROS-MODULE:kerberos] Initializing Kerberos delegation module
[KERBEROS-MODULE:kerberos] Configuration: {
  domainController: [32m'dc.company.com'[39m,
  realm: [32m'COMPANY.COM'[39m,
  servicePrincipalName: [32m'HTTP/webapp.company.com'[39m,
  kdc: [32m'kdc.company.com:88'[39m,
  enableS4U2Self: [33mtrue[39m,
  enableS4U2Proxy: [33mtrue[39m,
  allowedDelegationTargetsCount: [33m1[39m,
  ticketCacheEnabled: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Creating Kerberos client
[KERBEROS-MODULE:kerberos] Initializing ticket cache: { ttlSeconds: [33m3600[39m, renewThresholdSeconds: [33m300[39m }
[KERBEROS-MODULE:kerberos] Obtaining service ticket (TGT)

[KERBEROS-CLIENT] obtainServiceTicket() called
[KERBEROS-CLIENT] Service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] Service account: svc-mcp-server
[KERBEROS-CLIENT] Realm: COMPANY.COM
[KERBEROS-CLIENT] Domain Controller: dc.company.com
[KERBEROS-CLIENT] KDC: kdc.company.com:88
[KERBEROS-CLIENT] Password provided - attempting password authentication
[KERBEROS-CLIENT] NOTE: On Windows, password auth requires credentials in Windows Credential Manager
[KERBEROS-CLIENT] Initializing Kerberos client with node-kerberos library
[KERBEROS-CLIENT] Auth options: {
  principal: [32m'svc-mcp-server@COMPANY.COM'[39m,
  hasPassword: [33mtrue[39m,
  hasKeytab: [33mfalse[39m
}
[KERBEROS-CLIENT] Initializing client for service principal: HTTP/webapp.company.com@COMPANY.COM

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2minitialize()[2m > [22m[2mshould fail when service ticket not obtained
[22m[39m[KERBEROS-CLIENT] âœ“ Kerberos client initialized
[KERBEROS-CLIENT] Obtaining TGT (Ticket Granting Ticket)

[90mstderr[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2minitialize()[2m > [22m[2mshould fail when service ticket not obtained
[22m[39m[KERBEROS-CLIENT] âœ— Failed to obtain service ticket: [Error: InitializeSecurityContext: No credentials are available in the security package
]
[KERBEROS-CLIENT] Error details: {
  message: [32m'InitializeSecurityContext: No credentials are available in the security package\r\n'[39m,
  stack: [32m'Error: InitializeSecurityContext: No credentials are available in the security package\r\n'[39m
}
[KERBEROS-MODULE:kerberos] âœ— Failed to obtain service ticket: Error: Failed to obtain service ticket: InitializeSecurityContext: No credentials are available in the security package

    at KerberosClient.obtainServiceTicket [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-client.ts:178:13[90m)[39m
    at KerberosDelegationModule.initialize [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:114:7[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\kerberos\kerberos-module.test.ts:66:7
    at [90mfile:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:533:5
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1056:11[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runFiles [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1262:5[90m)[39m
    at startTests [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1271:3[90m)[39m

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould return failure result for any action
[22m[39m
[KERBEROS-MODULE:kerberos] Initializing Kerberos delegation module
[KERBEROS-MODULE:kerberos] Configuration: {
  domainController: [32m'dc.company.com'[39m,
  realm: [32m'COMPANY.COM'[39m,
  servicePrincipalName: [32m'HTTP/webapp.company.com'[39m,
  kdc: [32m'kdc.company.com:88'[39m,
  enableS4U2Self: [33mtrue[39m,
  enableS4U2Proxy: [33mtrue[39m,
  allowedDelegationTargetsCount: [33m1[39m,
  ticketCacheEnabled: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Creating Kerberos client
[KERBEROS-MODULE:kerberos] Initializing ticket cache: { ttlSeconds: [33m3600[39m, renewThresholdSeconds: [33m300[39m }
[KERBEROS-MODULE:kerberos] Obtaining service ticket (TGT)

[KERBEROS-CLIENT] obtainServiceTicket() called
[KERBEROS-CLIENT] Service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] Service account: svc-mcp-server
[KERBEROS-CLIENT] Realm: COMPANY.COM
[KERBEROS-CLIENT] Domain Controller: dc.company.com
[KERBEROS-CLIENT] KDC: kdc.company.com:88
[KERBEROS-CLIENT] Password provided - attempting password authentication
[KERBEROS-CLIENT] NOTE: On Windows, password auth requires credentials in Windows Credential Manager
[KERBEROS-CLIENT] Initializing Kerberos client with node-kerberos library
[KERBEROS-CLIENT] Auth options: {
  principal: [32m'svc-mcp-server@COMPANY.COM'[39m,
  hasPassword: [33mtrue[39m,
  hasKeytab: [33mfalse[39m
}
[KERBEROS-CLIENT] Initializing client for service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] âœ“ Kerberos client initialized
[KERBEROS-CLIENT] Obtaining TGT (Ticket Granting Ticket)

[90mstderr[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould return failure result for any action
[22m[39m[KERBEROS-CLIENT] âœ— Failed to obtain service ticket: [Error: InitializeSecurityContext: No credentials are available in the security package
]
[KERBEROS-CLIENT] Error details: {
  message: [32m'InitializeSecurityContext: No credentials are available in the security package\r\n'[39m,
  stack: [32m'Error: InitializeSecurityContext: No credentials are available in the security package\r\n'[39m
}
[KERBEROS-MODULE:kerberos] âœ— Failed to obtain service ticket: Error: Failed to obtain service ticket: InitializeSecurityContext: No credentials are available in the security package

    at KerberosClient.obtainServiceTicket [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-client.ts:178:13[90m)[39m
    at KerberosDelegationModule.initialize [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:114:7[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\kerberos\kerberos-module.test.ts:76:9
    at callSuiteHook [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:964:22[90m)[39m
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1040:30[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runFiles [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1262:5[90m)[39m
    at startTests [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1271:3[90m)[39m
[KERBEROS-CLIENT] Service ticket not available
[KERBEROS-MODULE] âœ— Delegation failed: Error: Service ticket not obtained. Call obtainServiceTicket() first.
    at KerberosClient.performS4U2Self [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-client.ts:210:13[90m)[39m
    at KerberosDelegationModule.performS4U2Self [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:297:35[90m)[39m
    at KerberosDelegationModule.delegate [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:198:20[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\kerberos\kerberos-module.test.ts:88:22
    at [90mfile:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:533:5
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1056:11[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runFiles [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1262:5[90m)[39m
[KERBEROS-MODULE] Error details: {
  message: [32m'Service ticket not obtained. Call obtainServiceTicket() first.'[39m,
  stack: [32m'Error: Service ticket not obtained. Call obtainServiceTicket() first.\n'[39m +
    [32m'    at KerberosClient.performS4U2Self (c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\packages\\kerberos-delegation\\src\\kerberos-client.ts:210:13)\n'[39m +
    [32m'    at KerberosDelegationModule.performS4U2Self (c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\packages\\kerberos-delegation\\src\\kerberos-module.ts:297:35)\n'[39m +
    [32m'    at KerberosDelegationModule.delegate (c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\packages\\kerberos-delegation\\src\\kerberos-module.ts:198:20)\n'[39m +
    [32m'    at c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\tests\\unit\\delegation\\kerberos\\kerberos-module.test.ts:88:22\n'[39m +
    [32m'    at file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:533:5\n'[39m +
    [32m'    at runTest (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1056:11)\n'[39m +
    [32m'    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)\n'[39m +
    [32m'    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)\n'[39m +
    [32m'    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)\n'[39m +
    [32m'    at runFiles (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1262:5)'[39m
}

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould return failure result for any action
[22m[39m
[KERBEROS-MODULE:kerberos] delegate() called
[KERBEROS-MODULE:kerberos] Action: s4u2self
[KERBEROS-MODULE:kerberos] Session: {
  userId: [32m'test-user'[39m,
  legacyUsername: [32m'COMPANY\\testuser'[39m,
  sessionId: [32m'test-session-id'[39m,
  hasDelegationToken: [33mfalse[39m,
  hasCustomClaims: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Params: { action: [32m's4u2self'[39m, userPrincipalName: [32m'user@COMPANY.COM'[39m }
[KERBEROS-MODULE] Using pre-validated legacy_username from session: COMPANY\testuser
[KERBEROS-MODULE] User principal: COMPANY\testuser@COMPANY.COM
[KERBEROS-MODULE] Executing action: s4u2self

[KERBEROS-CLIENT] performS4U2Self() called
[KERBEROS-CLIENT] User principal: COMPANY\testuser@COMPANY.COM
[KERBEROS-CLIENT] NOTE: Using stub implementation - node-kerberos does not support S4U2Self

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould return audit trail with source field
[22m[39m
[KERBEROS-MODULE:kerberos] Initializing Kerberos delegation module
[KERBEROS-MODULE:kerberos] Configuration: {
  domainController: [32m'dc.company.com'[39m,
  realm: [32m'COMPANY.COM'[39m,
  servicePrincipalName: [32m'HTTP/webapp.company.com'[39m,
  kdc: [32m'kdc.company.com:88'[39m,
  enableS4U2Self: [33mtrue[39m,
  enableS4U2Proxy: [33mtrue[39m,
  allowedDelegationTargetsCount: [33m1[39m,
  ticketCacheEnabled: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Creating Kerberos client
[KERBEROS-MODULE:kerberos] Initializing ticket cache: { ttlSeconds: [33m3600[39m, renewThresholdSeconds: [33m300[39m }
[KERBEROS-MODULE:kerberos] Obtaining service ticket (TGT)

[KERBEROS-CLIENT] obtainServiceTicket() called
[KERBEROS-CLIENT] Service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] Service account: svc-mcp-server
[KERBEROS-CLIENT] Realm: COMPANY.COM
[KERBEROS-CLIENT] Domain Controller: dc.company.com
[KERBEROS-CLIENT] KDC: kdc.company.com:88
[KERBEROS-CLIENT] Password provided - attempting password authentication
[KERBEROS-CLIENT] NOTE: On Windows, password auth requires credentials in Windows Credential Manager
[KERBEROS-CLIENT] Initializing Kerberos client with node-kerberos library
[KERBEROS-CLIENT] Auth options: {
  principal: [32m'svc-mcp-server@COMPANY.COM'[39m,
  hasPassword: [33mtrue[39m,
  hasKeytab: [33mfalse[39m
}
[KERBEROS-CLIENT] Initializing client for service principal: HTTP/webapp.company.com@COMPANY.COM

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould return audit trail with source field
[22m[39m[KERBEROS-CLIENT] âœ“ Kerberos client initialized
[KERBEROS-CLIENT] Obtaining TGT (Ticket Granting Ticket)

[90mstderr[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould return audit trail with source field
[22m[39m[KERBEROS-CLIENT] âœ— Failed to obtain service ticket: [Error: InitializeSecurityContext: No credentials are available in the security package
]
[KERBEROS-CLIENT] Error details: {
  message: [32m'InitializeSecurityContext: No credentials are available in the security package\r\n'[39m,
  stack: [32m'Error: InitializeSecurityContext: No credentials are available in the security package\r\n'[39m
}
[KERBEROS-MODULE:kerberos] âœ— Failed to obtain service ticket: Error: Failed to obtain service ticket: InitializeSecurityContext: No credentials are available in the security package

    at KerberosClient.obtainServiceTicket [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-client.ts:178:13[90m)[39m
    at KerberosDelegationModule.initialize [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:114:7[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\kerberos\kerberos-module.test.ts:76:9
    at callSuiteHook [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:964:22[90m)[39m
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1040:30[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runFiles [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1262:5[90m)[39m
    at startTests [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1271:3[90m)[39m
[KERBEROS-CLIENT] Service ticket not available
[KERBEROS-MODULE] âœ— Delegation failed: Error: Service ticket not obtained. Call obtainServiceTicket() first.
    at KerberosClient.performS4U2Self [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-client.ts:210:13[90m)[39m
    at KerberosDelegationModule.performS4U2Self [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:297:35[90m)[39m
    at KerberosDelegationModule.performS4U2Proxy [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:351:28[90m)[39m
    at KerberosDelegationModule.delegate [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:202:20[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\kerberos\kerberos-module.test.ts:100:22
    at [90mfile:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:533:5
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1056:11[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
[KERBEROS-MODULE] Error details: {
  message: [32m'Service ticket not obtained. Call obtainServiceTicket() first.'[39m,
  stack: [32m'Error: Service ticket not obtained. Call obtainServiceTicket() first.\n'[39m +
    [32m'    at KerberosClient.performS4U2Self (c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\packages\\kerberos-delegation\\src\\kerberos-client.ts:210:13)\n'[39m +
    [32m'    at KerberosDelegationModule.performS4U2Self (c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\packages\\kerberos-delegation\\src\\kerberos-module.ts:297:35)\n'[39m +
    [32m'    at KerberosDelegationModule.performS4U2Proxy (c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\packages\\kerberos-delegation\\src\\kerberos-module.ts:351:28)\n'[39m +
    [32m'    at KerberosDelegationModule.delegate (c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\packages\\kerberos-delegation\\src\\kerberos-module.ts:202:20)\n'[39m +
    [32m'    at c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\tests\\unit\\delegation\\kerberos\\kerberos-module.test.ts:100:22\n'[39m +
    [32m'    at file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:533:5\n'[39m +
    [32m'    at runTest (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1056:11)\n'[39m +
    [32m'    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)\n'[39m +
    [32m'    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)\n'[39m +
    [32m'    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)'[39m
}

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould return audit trail with source field
[22m[39m
[KERBEROS-MODULE:kerberos] delegate() called
[KERBEROS-MODULE:kerberos] Action: s4u2proxy
[KERBEROS-MODULE:kerberos] Session: {
  userId: [32m'test-user'[39m,
  legacyUsername: [32m'COMPANY\\testuser'[39m,
  sessionId: [32m'test-session-id'[39m,
  hasDelegationToken: [33mfalse[39m,
  hasCustomClaims: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Params: { action: [32m's4u2proxy'[39m, targetSPN: [32m'MSSQLSvc/sql01.company.com:1433'[39m }
[KERBEROS-MODULE] Using pre-validated legacy_username from session: COMPANY\testuser
[KERBEROS-MODULE] User principal: COMPANY\testuser@COMPANY.COM
[KERBEROS-MODULE] Executing action: s4u2proxy

[KERBEROS-CLIENT] performS4U2Self() called
[KERBEROS-CLIENT] User principal: COMPANY\testuser@COMPANY.COM
[KERBEROS-CLIENT] NOTE: Using stub implementation - node-kerberos does not support S4U2Self

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould include params in audit trail details
[22m[39m
[KERBEROS-MODULE:kerberos] Initializing Kerberos delegation module
[KERBEROS-MODULE:kerberos] Configuration: {
  domainController: [32m'dc.company.com'[39m,
  realm: [32m'COMPANY.COM'[39m,
  servicePrincipalName: [32m'HTTP/webapp.company.com'[39m,
  kdc: [32m'kdc.company.com:88'[39m,
  enableS4U2Self: [33mtrue[39m,
  enableS4U2Proxy: [33mtrue[39m,
  allowedDelegationTargetsCount: [33m1[39m,
  ticketCacheEnabled: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Creating Kerberos client
[KERBEROS-MODULE:kerberos] Initializing ticket cache: { ttlSeconds: [33m3600[39m, renewThresholdSeconds: [33m300[39m }
[KERBEROS-MODULE:kerberos] Obtaining service ticket (TGT)

[KERBEROS-CLIENT] obtainServiceTicket() called
[KERBEROS-CLIENT] Service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] Service account: svc-mcp-server
[KERBEROS-CLIENT] Realm: COMPANY.COM
[KERBEROS-CLIENT] Domain Controller: dc.company.com
[KERBEROS-CLIENT] KDC: kdc.company.com:88
[KERBEROS-CLIENT] Password provided - attempting password authentication
[KERBEROS-CLIENT] NOTE: On Windows, password auth requires credentials in Windows Credential Manager
[KERBEROS-CLIENT] Initializing Kerberos client with node-kerberos library
[KERBEROS-CLIENT] Auth options: {
  principal: [32m'svc-mcp-server@COMPANY.COM'[39m,
  hasPassword: [33mtrue[39m,
  hasKeytab: [33mfalse[39m
}
[KERBEROS-CLIENT] Initializing client for service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] âœ“ Kerberos client initialized
[KERBEROS-CLIENT] Obtaining TGT (Ticket Granting Ticket)

[KERBEROS-MODULE:kerberos] delegate() called
[KERBEROS-MODULE:kerberos] Action: obtain-ticket
[KERBEROS-MODULE:kerberos] Session: {
  userId: [32m'test-user'[39m,
  legacyUsername: [32m'COMPANY\\testuser'[39m,
  sessionId: [32m'test-session-id'[39m,
  hasDelegationToken: [33mfalse[39m,
  hasCustomClaims: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Params: { action: [32m'obtain-ticket'[39m, userPrincipalName: [32m'admin@COMPANY.COM'[39m }
[KERBEROS-MODULE] Using pre-validated legacy_username from session: COMPANY\testuser
[KERBEROS-MODULE] User principal: COMPANY\testuser@COMPANY.COM
[KERBEROS-MODULE] Executing action: obtain-ticket

[KERBEROS-CLIENT] performS4U2Self() called
[KERBEROS-CLIENT] User principal: COMPANY\testuser@COMPANY.COM
[KERBEROS-CLIENT] NOTE: Using stub implementation - node-kerberos does not support S4U2Self

[90mstderr[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould include params in audit trail details
[22m[39m[KERBEROS-CLIENT] âœ— Failed to obtain service ticket: [Error: InitializeSecurityContext: No credentials are available in the security package
]
[KERBEROS-CLIENT] Error details: {
  message: [32m'InitializeSecurityContext: No credentials are available in the security package\r\n'[39m,
  stack: [32m'Error: InitializeSecurityContext: No credentials are available in the security package\r\n'[39m
}
[KERBEROS-MODULE:kerberos] âœ— Failed to obtain service ticket: Error: Failed to obtain service ticket: InitializeSecurityContext: No credentials are available in the security package

    at KerberosClient.obtainServiceTicket [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-client.ts:178:13[90m)[39m
    at KerberosDelegationModule.initialize [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:114:7[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\kerberos\kerberos-module.test.ts:76:9
    at callSuiteHook [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:964:22[90m)[39m
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1040:30[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runFiles [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1262:5[90m)[39m
    at startTests [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1271:3[90m)[39m
[KERBEROS-CLIENT] Service ticket not available
[KERBEROS-MODULE] âœ— Delegation failed: Error: Service ticket not obtained. Call obtainServiceTicket() first.
    at KerberosClient.performS4U2Self [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-client.ts:210:13[90m)[39m
    at KerberosDelegationModule.performS4U2Self [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:297:35[90m)[39m
    at KerberosDelegationModule.delegate [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:207:20[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\kerberos\kerberos-module.test.ts:115:22
    at [90mfile:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:533:5
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1056:11[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runFiles [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1262:5[90m)[39m
[KERBEROS-MODULE] Error details: {
  message: [32m'Service ticket not obtained. Call obtainServiceTicket() first.'[39m,
  stack: [32m'Error: Service ticket not obtained. Call obtainServiceTicket() first.\n'[39m +
    [32m'    at KerberosClient.performS4U2Self (c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\packages\\kerberos-delegation\\src\\kerberos-client.ts:210:13)\n'[39m +
    [32m'    at KerberosDelegationModule.performS4U2Self (c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\packages\\kerberos-delegation\\src\\kerberos-module.ts:297:35)\n'[39m +
    [32m'    at KerberosDelegationModule.delegate (c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\packages\\kerberos-delegation\\src\\kerberos-module.ts:207:20)\n'[39m +
    [32m'    at c:\\Users\\gazza\\Local Documents\\GitHub\\MCP Services\\MCP-Oauth\\tests\\unit\\delegation\\kerberos\\kerberos-module.test.ts:115:22\n'[39m +
    [32m'    at file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:533:5\n'[39m +
    [32m'    at runTest (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1056:11)\n'[39m +
    [32m'    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)\n'[39m +
    [32m'    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)\n'[39m +
    [32m'    at runSuite (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1205:15)\n'[39m +
    [32m'    at runFiles (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/@vitest/runner/dist/index.js:1262:5)'[39m
}

[90mstdout[2m | tests/integration/core/standalone.test.ts[2m > [22m[2mCore Module Standalone Integration[2m > [22m[2mRole Mapper Standalone[2m > [22m[2mshould create and use RoleMapper without dependencies
[22m[39m[RoleMapper] determineRoles called with: [ [32m'admin'[39m, [32m'user'[39m ]
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Valid roles after filtering: [ [32m'admin'[39m, [32m'user'[39m ]
[RoleMapper] Primary role determined: admin
[RoleMapper] Custom roles determined: []

[90mstdout[2m | tests/integration/core/standalone.test.ts[2m > [22m[2mCore Module Standalone Integration[2m > [22m[2mRole Mapper Standalone[2m > [22m[2mshould handle role mapping failure gracefully
[22m[39m[RoleMapper] determineRoles called with: [1mnull[22m
[RoleMapper] Config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m ],
  userRoles: [ [32m'user'[39m ],
  guestRoles: [],
  customRoles: {},
  defaultRole: [32m'guest'[39m
}
[RoleMapper] Invalid input: not an array

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould handle validate-ticket action
[22m[39m
[KERBEROS-MODULE:kerberos] Initializing Kerberos delegation module
[KERBEROS-MODULE:kerberos] Configuration: {
  domainController: [32m'dc.company.com'[39m,
  realm: [32m'COMPANY.COM'[39m,
  servicePrincipalName: [32m'HTTP/webapp.company.com'[39m,
  kdc: [32m'kdc.company.com:88'[39m,
  enableS4U2Self: [33mtrue[39m,
  enableS4U2Proxy: [33mtrue[39m,
  allowedDelegationTargetsCount: [33m1[39m,
  ticketCacheEnabled: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Creating Kerberos client
[KERBEROS-MODULE:kerberos] Initializing ticket cache: { ttlSeconds: [33m3600[39m, renewThresholdSeconds: [33m300[39m }
[KERBEROS-MODULE:kerberos] Obtaining service ticket (TGT)

[KERBEROS-CLIENT] obtainServiceTicket() called
[KERBEROS-CLIENT] Service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] Service account: svc-mcp-server
[KERBEROS-CLIENT] Realm: COMPANY.COM
[KERBEROS-CLIENT] Domain Controller: dc.company.com
[KERBEROS-CLIENT] KDC: kdc.company.com:88
[KERBEROS-CLIENT] Password provided - attempting password authentication
[KERBEROS-CLIENT] NOTE: On Windows, password auth requires credentials in Windows Credential Manager
[KERBEROS-CLIENT] Initializing Kerberos client with node-kerberos library
[KERBEROS-CLIENT] Auth options: {
  principal: [32m'svc-mcp-server@COMPANY.COM'[39m,
  hasPassword: [33mtrue[39m,
  hasKeytab: [33mfalse[39m
}
[KERBEROS-CLIENT] Initializing client for service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] âœ“ Kerberos client initialized
[KERBEROS-CLIENT] Obtaining TGT (Ticket Granting Ticket)

[KERBEROS-MODULE:kerberos] delegate() called
[KERBEROS-MODULE:kerberos] Action: validate-ticket
[KERBEROS-MODULE:kerberos] Session: {
  userId: [32m'test-user'[39m,
  legacyUsername: [32m'COMPANY\\testuser'[39m,
  sessionId: [32m'test-session-id'[39m,
  hasDelegationToken: [33mfalse[39m,
  hasCustomClaims: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Params: { action: [32m'validate-ticket'[39m, ticket: [32m'base64-encoded-ticket'[39m }
[KERBEROS-MODULE] Using pre-validated legacy_username from session: COMPANY\testuser
[KERBEROS-MODULE] User principal: COMPANY\testuser@COMPANY.COM
[KERBEROS-MODULE] Executing action: validate-ticket

[90mstdout[2m | tests/integration/phase1-extension.test.ts
[22m[39m[getAllToolFactories] excludeSqlTools=undefined, including 3 SQL tools

[90mstderr[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdelegate()[2m > [22m[2mshould handle validate-ticket action
[22m[39m[KERBEROS-CLIENT] âœ— Failed to obtain service ticket: [Error: InitializeSecurityContext: No credentials are available in the security package
]
[KERBEROS-CLIENT] Error details: {
  message: [32m'InitializeSecurityContext: No credentials are available in the security package\r\n'[39m,
  stack: [32m'Error: InitializeSecurityContext: No credentials are available in the security package\r\n'[39m
}
[KERBEROS-MODULE:kerberos] âœ— Failed to obtain service ticket: Error: Failed to obtain service ticket: InitializeSecurityContext: No credentials are available in the security package

    at KerberosClient.obtainServiceTicket [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-client.ts:178:13[90m)[39m
    at KerberosDelegationModule.initialize [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:114:7[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\kerberos\kerberos-module.test.ts:76:9
    at callSuiteHook [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:964:22[90m)[39m
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1040:30[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runFiles [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1262:5[90m)[39m
    at startTests [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1271:3[90m)[39m

[90mstdout[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdestroy()[2m > [22m[2mshould clear config after destroy
[22m[39m
[KERBEROS-MODULE:kerberos] Initializing Kerberos delegation module
[KERBEROS-MODULE:kerberos] Configuration: {
  domainController: [32m'dc.company.com'[39m,
  realm: [32m'COMPANY.COM'[39m,
  servicePrincipalName: [32m'HTTP/webapp.company.com'[39m,
  kdc: [32m'kdc.company.com:88'[39m,
  enableS4U2Self: [33mtrue[39m,
  enableS4U2Proxy: [33mtrue[39m,
  allowedDelegationTargetsCount: [33m1[39m,
  ticketCacheEnabled: [33mtrue[39m
}
[KERBEROS-MODULE:kerberos] Creating Kerberos client
[KERBEROS-MODULE:kerberos] Initializing ticket cache: { ttlSeconds: [33m3600[39m, renewThresholdSeconds: [33m300[39m }
[KERBEROS-MODULE:kerberos] Obtaining service ticket (TGT)

[KERBEROS-CLIENT] obtainServiceTicket() called
[KERBEROS-CLIENT] Service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] Service account: svc-mcp-server
[KERBEROS-CLIENT] Realm: COMPANY.COM
[KERBEROS-CLIENT] Domain Controller: dc.company.com
[KERBEROS-CLIENT] KDC: kdc.company.com:88
[KERBEROS-CLIENT] Password provided - attempting password authentication
[KERBEROS-CLIENT] NOTE: On Windows, password auth requires credentials in Windows Credential Manager
[KERBEROS-CLIENT] Initializing Kerberos client with node-kerberos library
[KERBEROS-CLIENT] Auth options: {
  principal: [32m'svc-mcp-server@COMPANY.COM'[39m,
  hasPassword: [33mtrue[39m,
  hasKeytab: [33mfalse[39m
}
[KERBEROS-CLIENT] Initializing client for service principal: HTTP/webapp.company.com@COMPANY.COM
[KERBEROS-CLIENT] âœ“ Kerberos client initialized
[KERBEROS-CLIENT] Obtaining TGT (Ticket Granting Ticket)

 [32mâœ“[39m tests/integration/core/standalone.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 514[2mms[22m[39m
   [33m[2mâœ“[22m[39m Core Module Standalone Integration[2m > [22mModule Imports[2m > [22mshould import core module [33m451[2mms[22m[39m
[90mstderr[2m | tests/unit/delegation/kerberos/kerberos-module.test.ts[2m > [22m[2mKerberosDelegationModule (Placeholder)[2m > [22m[2mdestroy()[2m > [22m[2mshould clear config after destroy
[22m[39m[KERBEROS-CLIENT] âœ— Failed to obtain service ticket: [Error: InitializeSecurityContext: No credentials are available in the security package
]
[KERBEROS-CLIENT] Error details: {
  message: [32m'InitializeSecurityContext: No credentials are available in the security package\r\n'[39m,
  stack: [32m'Error: InitializeSecurityContext: No credentials are available in the security package\r\n'[39m
}
[KERBEROS-MODULE:kerberos] âœ— Failed to obtain service ticket: Error: Failed to obtain service ticket: InitializeSecurityContext: No credentials are available in the security package

    at KerberosClient.obtainServiceTicket [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-client.ts:178:13[90m)[39m
    at KerberosDelegationModule.initialize [90m(c:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mpackages\kerberos-delegation\src\kerberos-module.ts:114:7[90m)[39m
    at [90mc:\Users\gazza\Local Documents\GitHub\MCP Services\MCP-Oauth\[39mtests\unit\delegation\kerberos\kerberos-module.test.ts:162:9
    at [90mfile:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:533:5
    at runTest [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1056:11[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runSuite [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1205:15[90m)[39m
    at runFiles [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1262:5[90m)[39m
    at startTests [90m(file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1271:3[90m)[39m

 [32mâœ“[39m tests/unit/delegation/kerberos/kerberos-module.test.ts [2m([22m[2m14 tests[22m[2m)[22m[90m 186[2mms[22m[39m
[90mstdout[2m | tests/integration/phase1-extension.test.ts[2m > [22m[2mPhase 1: Extension API Integration Tests
[22m[39m[MCP OAuth Server] Starting server...
[MCP OAuth Server] Loading configuration from: ./test-harness/config/v2-keycloak-oauth-only.json

[90mstderr[2m | tests/integration/phase1-extension.test.ts[2m > [22m[2mPhase 1: Extension API Integration Tests
[22m[39m[FastMCP error] Authentication failed for stdio transport: Cannot read properties of undefined (reading 'method')

[90mstdout[2m | tests/integration/phase1-extension.test.ts[2m > [22m[2mPhase 1: Extension API Integration Tests
[22m[39m[MCP OAuth Server] Building CoreContext...
[ConfigOrchestrator] Raw roleMappings from config: {
  admin: [ [32m'admin'[39m, [32m'administrator'[39m, [32m'realm-admin'[39m, [32m'mcp-oauth-admin'[39m ],
  user: [ [32m'user'[39m, [32m'authenticated'[39m ],
  guest: [ [32m'guest'[39m, [32m'anonymous'[39m ],
  defaultRole: [32m'guest'[39m,
  rejectUnmappedRoles: [33mfalse[39m,
  write: [ [32m'mcp-oauth-write'[39m ],
  read: [ [32m'mcp-oauth-read'[39m ]
}
[ConfigOrchestrator] Extracted custom roles: { write: [ [32m'mcp-oauth-write'[39m ], read: [ [32m'mcp-oauth-read'[39m ] }
[ConfigOrchestrator] Final role mapping config: {
  adminRoles: [ [32m'admin'[39m, [32m'administrator'[39m, [32m'realm-admin'[39m, [32m'mcp-oauth-admin'[39m ],
  userRoles: [ [32m'user'[39m, [32m'authenticated'[39m ],
  guestRoles: [ [32m'guest'[39m, [32m'anonymous'[39m ],
  defaultRole: [32m'guest'[39m,
  rejectUnmappedRoles: [33mfalse[39m,
  customRoles: { write: [ [32m'mcp-oauth-write'[39m ], read: [ [32m'mcp-oauth-read'[39m ] }
}
[ConfigOrchestrator] Auth config built (no token exchange at auth level)
[MCP OAuth Server] Initializing AuthenticationService (fetching JWKS)...
[MCP OAuth Server] âœ“ AuthenticationService initialized
[MCP OAuth Server] Validating CoreContext...
[MCP OAuth Server] âœ“ CoreContext validated
[MCP OAuth Server] Creating FastMCP server: MCP OAuth v2 Test Server v2.0.0
[MCP OAuth Server] Building OAuth configuration...
[MCP OAuth Server]   Primary IDP: http://localhost:8080/realms/mcp_security
[MCP OAuth Server]   Resource URL: http://localhost:3000
[MCP OAuth Server] DEBUG - mcpConfig.oauth: {
  "supportedGrantTypes": [
    "urn:ietf:params:oauth:grant-type:token-exchange"
  ],
  "scopes": [
    "mcp:read",
    "mcp:write",
    "mcp:admin"
  ]
}
[MCP OAuth Server]   WARNING: No oauth_endpoints configured in mcp.oauth
[MCP OAuth Server] DEBUG - Final oauthConfig: {
  "enabled": true,
  "authorizationServer": {
    "issuer": "http://localhost:8080/realms/mcp_security",
    "authorizationEndpoint": "http://localhost:8080/realms/mcp_security/protocol/openid-connect/auth",
    "tokenEndpoint": "http://localhost:8080/realms/mcp_security/protocol/openid-connect/token",
    "jwksUri": "http://localhost:8080/realms/mcp_security/protocol/openid-connect/certs",
    "responseTypesSupported": [
      "code"
    ],
    "grantTypesSupported": [
      "authorization_code",
      "refresh_token"
    ],
    "codeChallengeMethodsSupported": [
      "S256"
    ],
    "scopesSupported": [
      "openid",
      "profile",
      "email"
    ],
    "tokenEndpointAuthMethodsSupported": [
      "client_secret_basic",
      "client_secret_post"
    ]
  },
  "protectedResource": {
    "resource": "http://localhost:3000",
    "authorizationServers": [
      "http://localhost:8080/realms/mcp_security"
    ],
    "scopesSupported": [
      "mcp:read",
      "mcp:write",
      "mcp:admin"
    ],
    "bearerMethodsSupported": [
      "header"
    ],
    "resourceSigningAlgValuesSupported": [
      "RS256"
    ],
    "resourceDocumentation": "http://localhost:3000/docs",
    "acceptTypesSupported": [
      "application/json",
      "text/event-stream"
    ]
  }
}
[MCP OAuth Server] Checking for custom SQL tools...
[MCP OAuth Server]   Enabled tool names: []
[MCP OAuth Server]   Has custom SQL tools: [33mfalse[39m
[getAllToolFactories] excludeSqlTools=false, including 3 SQL tools
[MCP OAuth Server] Found 8 available tools
[MCP OAuth Server] Enabled tools config: {}
[MCP OAuth Server] Registering tool (no filter): sql-delegate
[MCP OAuth Server] Registering tool (no filter): sql-schema
[MCP OAuth Server] Registering tool (no filter): sql-table-details
[MCP OAuth Server] Registering tool (no filter): health-check
[MCP OAuth Server] Registering tool (no filter): user-info
[MCP OAuth Server] Registering tool (no filter): kerberos-list-directory
[MCP OAuth Server] Registering tool (no filter): kerberos-read-file
[MCP OAuth Server] Registering tool (no filter): kerberos-file-info
[MCP OAuth Server] Successfully registered 8 of 8 available tools
[MCP OAuth Server] Starting FastMCP server...

[90mstdout[2m | tests/integration/mcp/standalone.test.ts[2m > [22m[2mMCP Layer - Standalone Integration[2m > [22m[2mModule Imports[2m > [22m[2mshould import tool factories
[22m[39m[getAllToolFactories] excludeSqlTools=undefined, including 3 SQL tools

 [32mâœ“[39m tests/integration/delegation/standalone.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2819[2mms[22m[39m
   [33m[2mâœ“[22m[39m Delegation Layer Standalone Integration[2m > [22mModule Imports[2m > [22mshould export SQLDelegationModule from package [33m2541[2mms[22m[39m
 [32mâœ“[39m tests/integration/phase4-modularity.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 3104[2mms[22m[39m
   [33m[2mâœ“[22m[39m Phase 4: Monorepo Modularity[2m > [22mCore Framework Independence[2m > [22mshould import core framework without SQL dependencies [33m669[2mms[22m[39m
   [33m[2mâœ“[22m[39m Phase 4: Monorepo Modularity[2m > [22mSQL Delegation Package[2m > [22mshould import SQL delegation from separate package source [33m2108[2mms[22m[39m
[90mstdout[2m | tests/integration/phase1-extension.test.ts[2m > [22m[2mPhase 1: Extension API Integration Tests[2m > [22m[2mMCPOAuthServer.registerTool()[2m > [22m[2mshould register a single custom tool
[22m[39m[MCP OAuth Server] Registering custom tool: test-single-register

[90mstdout[2m | tests/integration/phase1-extension.test.ts[2m > [22m[2mPhase 1: Extension API Integration Tests[2m > [22m[2mMCPOAuthServer.registerTools()[2m > [22m[2mshould register multiple tools at once
[22m[39m[MCP OAuth Server] Registering 2 custom tools...
[MCP OAuth Server] Registering custom tool: test-batch-1
[MCP OAuth Server] Registering custom tool: test-batch-2
[MCP OAuth Server] âœ“ Successfully registered 2 custom tools

[90mstdout[2m | tests/integration/phase1-extension.test.ts[2m > [22m[2mPhase 1: Extension API Integration Tests[2m > [22m[2mEnd-to-End: Custom Module Extension[2m > [22m[2mshould support full custom delegation workflow
[22m[39m[MCP OAuth Server] Registering custom tool: custom-echo

[90mstderr[2m | tests/integration/phase1-extension.test.ts[2m > [22m[2mPhase 1: Extension API Integration Tests
[22m[39m[FastMCP warning] could not infer client capabilities after 10 attempts. Connection may be unstable.

[90mstdout[2m | tests/integration/phase1-extension.test.ts[2m > [22m[2mPhase 1: Extension API Integration Tests
[22m[39m
============================================================
[MCP OAuth Server] âœ“ Server started successfully
============================================================
  Server Name:      MCP OAuth v2 Test Server
  Version:          2.0.0
  Transport:        http-stream
  Authentication:   OAuth 2.1 with JWT
  Tools Registered: 8
  Audit Logging:    Enabled
============================================================

[MCP OAuth Server] Registered delegation module: testmodule
[MCP OAuth Server] Stopping server...
[MCP OAuth Server] âœ“ FastMCP server stopped
[MCP OAuth Server] âœ“ CoreContext destroyed
[MCP OAuth Server] âœ“ Server stopped

[90mstdout[2m | tests/unit/mcp/server.test.ts
[22m[39m[getAllToolFactories] excludeSqlTools=undefined, including 3 SQL tools

 [32mâœ“[39m tests/integration/phase1-extension.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1173[2mms[22m[39m
[90mstdout[2m | tests/unit/mcp/server.test.ts[2m > [22m[2mMCPOAuthServer[2m > [22m[2mstop()[2m > [22m[2mshould handle stop when server is not running
[22m[39m[MCP OAuth Server] Server is not running

 [32mâœ“[39m tests/unit/mcp/server.test.ts [2m([22m[2m13 tests[22m[2m)[22m[90m 44[2mms[22m[39m
 [32mâœ“[39m tests/integration/mcp/standalone.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1854[2mms[22m[39m
   [33m[2mâœ“[22m[39m MCP Layer - Standalone Integration[2m > [22mModule Imports[2m > [22mshould import ConfigOrchestrator [33m552[2mms[22m[39m
   [33m[2mâœ“[22m[39m MCP Layer - Standalone Integration[2m > [22mPublic API Exports[2m > [22mshould export all MCP public APIs [33m978[2mms[22m[39m

[2m Test Files [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m      Tests [22m [1m[32m447 passed[39m[22m[90m (447)[39m
[2m   Start at [22m 11:14:57
[2m   Duration [22m 6.85s[2m (transform 9.65s, setup 0ms, collect 22.98s, tests 11.11s, environment 31ms, prepare 15.22s)[22m

[34m % [39m[2mCoverage report from [22m[33mv8[39m
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |   37.32 |    76.72 |   55.93 |   37.32 |                   
 config            |   29.56 |    52.77 |   36.66 |   29.56 |                   
  manager.ts       |   60.82 |    45.83 |   47.36 |   60.82 | ...80,185,188-191 
  manager.ts       |       0 |        0 |       0 |       0 | 1-217             
  migrate.ts       |    72.5 |    88.88 |      25 |    72.5 | ...88-125,129-141 
  migrate.ts       |       0 |        0 |       0 |       0 | 1-251             
  schema.ts        |       0 |        0 |       0 |       0 | 1-126             
 config/schemas    |   42.79 |    80.95 |   29.16 |   42.79 |                   
  core.ts          |   98.96 |      100 |   45.45 |   98.96 | 57,141            
  core.ts          |       0 |        0 |       0 |       0 | 1-193             
  delegation.ts    |   96.84 |      100 |   16.66 |   96.84 | 18-21,68,124-125  
  delegation.ts    |       0 |        0 |       0 |       0 | 1-222             
  kerberos.ts      |       0 |        0 |       0 |       0 | 1-156             
  mcp.ts           |   99.15 |      100 |   33.33 |   99.15 | 89                
  mcp.ts           |       0 |        0 |       0 |       0 | 1-118             
 core              |   43.53 |    81.02 |   75.86 |   43.53 |                   
  audit-service.ts |   99.51 |      100 |   91.66 |   99.51 | 27                
  audit-service.ts |       0 |        0 |       0 |       0 | 1-207             
  ...on-service.ts |   98.98 |       88 |   88.88 |   98.98 | 51-53             
  ...on-service.ts |       0 |        0 |       0 |       0 | 1-297             
  jwt-validator.ts |   66.28 |     47.5 |   66.66 |   66.28 | ...46-365,368-378 
  jwt-validator.ts |       0 |        0 |       0 |       0 | 1-525             
  role-mapper.ts   |   94.92 |     90.9 |     100 |   94.92 | ...06-115,129,143 
  role-mapper.ts   |       0 |        0 |       0 |       0 | 1-256             
  ...on-manager.ts |   95.62 |    89.47 |      75 |   95.62 | 81,101,107-112    
  ...on-manager.ts |       0 |        0 |       0 |       0 | 1-183             
  validators.ts    |     100 |      100 |     100 |     100 |                   
  validators.ts    |       0 |        0 |       0 |       0 | 1-95              
 delegation        |   46.04 |    83.42 |   83.33 |   46.04 |                   
  ...oken-cache.ts |   97.75 |    92.18 |     100 |   97.75 | 231-245           
  ...oken-cache.ts |       0 |        0 |       0 |       0 | 1-669             
  registry.ts      |   99.72 |       88 |     100 |   99.72 | 263               
  registry.ts      |       0 |        0 |       0 |       0 | 1-361             
  ...n-exchange.ts |   78.68 |    74.13 |   64.28 |   78.68 | ...81-292,357-360 
  ...n-exchange.ts |       0 |        0 |       0 |       0 | 1-488             
 mcp               |   42.31 |    70.07 |   67.69 |   42.31 |                   
  authorization.ts |   88.62 |    92.85 |   68.42 |   88.62 | ...88-300,317-329 
  authorization.ts |       0 |        0 |       0 |       0 | 1-457             
  http-server.ts   |       0 |        0 |       0 |       0 | 1-171             
  middleware.ts    |   92.49 |    78.37 |     100 |   92.49 | ...08-117,128-134 
  middleware.ts    |       0 |        0 |       0 |       0 | 1-293             
  ...h-metadata.ts |   73.14 |      100 |       0 |   73.14 | ...49-51,58,60-67 
  ...h-metadata.ts |       0 |        0 |       0 |       0 | 1-175             
  orchestrator.ts  |     100 |       65 |     100 |     100 | ...,86-91,117-127 
  orchestrator.ts  |       0 |        0 |       0 |       0 | 1-247             
  server.ts        |   86.67 |    59.09 |   81.25 |   86.67 | ...50-452,464-476 
  server.ts        |       0 |        0 |       0 |       0 | 1-653             
 mcp/tools         |   28.09 |    78.57 |   37.68 |   28.09 |                   
  ...ol-factory.ts |   95.33 |    71.42 |   83.33 |   95.33 | 38-43,56,71,92-99 
  ...ol-factory.ts |       0 |        0 |       0 |       0 | 1-343             
  health-check.ts  |     100 |    94.44 |     100 |     100 | 86                
  health-check.ts  |       0 |        0 |       0 |       0 | 1-142             
  index.ts         |   93.75 |      100 |      25 |   93.75 | 64-67,85-86       
  index.ts         |       0 |        0 |       0 |       0 | 1-96              
  ...s-delegate.ts |       0 |        0 |       0 |       0 | 1-274             
  ...ile-browse.ts |   44.19 |      100 |   42.85 |   44.19 | ...88-291,294-384 
  ...ile-browse.ts |       0 |        0 |       0 |       0 | 1-482             
  ...ls-factory.ts |   36.86 |      100 |       0 |   36.86 | ...15-168,174-184 
  ...ls-factory.ts |       0 |        0 |       0 |       0 | 1-236             
  sql-delegate.ts  |   68.05 |      100 |      50 |   68.05 | 52-57,60-99       
  sql-delegate.ts  |       0 |        0 |       0 |       0 | 1-144             
  sql-schema.ts    |   42.75 |      100 |      50 |   42.75 | 39-42,44-118      
  sql-schema.ts    |       0 |        0 |       0 |       0 | 1-138             
  ...le-details.ts |   45.94 |      100 |      50 |   45.94 | 41-44,46-121      
  ...le-details.ts |       0 |        0 |       0 |       0 | 1-148             
  ...ls-factory.ts |   30.16 |      100 |       0 |   30.16 | ...76,284,286-296 
  ...ls-factory.ts |       0 |        0 |       0 |       0 | 1-358             
  user-info.ts     |   97.16 |    85.71 |     100 |   97.16 | 93-96             
  user-info.ts     |       0 |        0 |       0 |       0 | 1-141             
 mcp/utils         |   47.66 |    41.66 |      75 |   47.66 |                   
  error-helpers.ts |   95.32 |    45.45 |     100 |   95.32 | 45,48-51          
  error-helpers.ts |       0 |        0 |       0 |       0 | 1-107             
 testing           |       0 |        0 |       0 |       0 |                   
  index.ts         |       0 |        0 |       0 |       0 | 1-390             
 types             |       0 |        0 |       0 |       0 |                   
  index.ts         |       0 |        0 |       0 |       0 | 1-138             
 utils             |   27.35 |    85.71 |      20 |   27.35 |                   
  errors.ts        |    54.7 |      100 |   21.05 |    54.7 | ...,74-96,105-117 
  errors.ts        |       0 |        0 |       0 |       0 | 1-117             
-------------------|---------|----------|---------|---------|-------------------
ERROR: Coverage for lines (37.32%) does not meet global threshold (80%)
ERROR: Coverage for functions (55.93%) does not meet global threshold (80%)
ERROR: Coverage for statements (37.32%) does not meet global threshold (80%)
[1m[7m[32m PASS [39m[27m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[7m[34m RERUN [39m[27m[22m [34m[2mc:/Users/gazza/Local Documents/GitHub/MCP Services/MCP-Oauth/tests/unit/mcp/http-server.test.ts [22m[34mx1 [34m[39m

 [31mâ¯[39m tests/unit/mcp/http-server.test.ts [2m([22m[2m0 test[22m[2m)[22m
node:events:496
      throw er; // Unhandled 'error' event
      ^

Error: Worker exited unexpectedly
    at ChildProcess.onUnexpectedExit (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/tinypool/dist/index.js:118:30)
    at ChildProcess.emit (node:events:530:35)
    at ChildProcess._handle.onexit (node:internal/child_process:293:12)
Emitted 'error' event on Tinypool instance at:
    at EventEmitterReferencingAsyncResource.runInAsyncScope (node:async_hooks:211:14)
    at Tinypool.emit (node:events:170:18)
    at file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/tinypool/dist/index.js:594:30
    at ChildProcess.<anonymous> (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/tinypool/dist/index.js:162:34)
    at ChildProcess.emit (node:events:518:28)
    at ChildProcess.onUnexpectedExit (file:///c:/Users/gazza/Local%20Documents/GitHub/MCP%20Services/MCP-Oauth/node_modules/tinypool/dist/index.js:118:16)
    at ChildProcess.emit (node:events:530:35)
    at ChildProcess._handle.onexit (node:internal/child_process:293:12)

Node.js v22.14.0
