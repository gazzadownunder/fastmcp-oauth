#!/usr/bin/env node

/**
 * MCP OAuth Delegation Module Scaffolder
 *
 * CLI tool to scaffold a new delegation module with boilerplate code.
 *
 * Usage:
 *   npx mcp-oauth-scaffold <module-name> --type <type>
 *   npx mcp-oauth-scaffold myapi --type rest-api
 *
 * Options:
 *   --type       Module type (rest-api, graphql, grpc, ldap, filesystem, database, custom)
 *   --output     Output directory (default: src/delegation/<module-name>)
 *   --examples   Generate example tools (default: true)
 *   --tests      Generate test file (default: true)
 */

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Parse command line arguments
const args = process.argv.slice(2);
const moduleName = args[0];

if (!moduleName) {
  console.error('‚ùå Error: Module name is required');
  console.log('\nUsage: npx mcp-oauth-scaffold <module-name> [options]');
  console.log('\nOptions:');
  console.log('  --type <type>      Module type (rest-api, graphql, grpc, ldap, filesystem, database, custom)');
  console.log('  --output <dir>     Output directory (default: src/delegation/<module-name>)');
  console.log('  --examples         Generate example tools (default: true)');
  console.log('  --tests            Generate test file (default: true)');
  console.log('\nExamples:');
  console.log('  npx mcp-oauth-scaffold myapi --type rest-api');
  console.log('  npx mcp-oauth-scaffold ldap-service --type ldap --output ./custom');
  process.exit(1);
}

// Parse options
const getOption = (name, defaultValue) => {
  const index = args.indexOf(`--${name}`);
  if (index === -1) return defaultValue;
  return args[index + 1] || defaultValue;
};

const hasFlag = (name) => args.includes(`--${name}`);

const moduleType = getOption('type', 'custom');
const outputDir = getOption('output', `src/delegation/${moduleName}`);
const generateExamples = !hasFlag('no-examples');
const generateTests = !hasFlag('no-tests');

// Validate module type
const validTypes = ['rest-api', 'graphql', 'grpc', 'ldap', 'filesystem', 'database', 'custom'];
if (!validTypes.includes(moduleType)) {
  console.error(`‚ùå Error: Invalid module type "${moduleType}"`);
  console.log(`Valid types: ${validTypes.join(', ')}`);
  process.exit(1);
}

// Generate module name variants
const modulePascalCase = moduleName
  .split('-')
  .map(w => w.charAt(0).toUpperCase() + w.slice(1))
  .join('');
const moduleCamelCase = moduleName
  .split('-')
  .map((w, i) => i === 0 ? w : w.charAt(0).toUpperCase() + w.slice(1))
  .join('');

console.log(`\nüöÄ Scaffolding delegation module: ${moduleName}`);
console.log(`   Type: ${moduleType}`);
console.log(`   Output: ${outputDir}\n`);

// Create output directory
fs.mkdirSync(outputDir, { recursive: true });

// Generate module implementation
const moduleTemplate = `/**
 * ${modulePascalCase} Delegation Module
 *
 * ${getModuleDescription(moduleType)}
 *
 * Generated by: mcp-oauth-scaffold
 * Module type: ${moduleType}
 */

import type { DelegationModule, DelegationResult } from '../base.js';
import type { UserSession, AuditEntry } from '../../core/index.js';
import type { CoreContext } from '../../core/types.js';

/**
 * ${modulePascalCase} module configuration
 */
export interface ${modulePascalCase}Config {
  ${getConfigFields(moduleType)}
}

/**
 * ${modulePascalCase} request parameters
 */
export interface ${modulePascalCase}Request {
  ${getRequestFields(moduleType)}
}

/**
 * ${modulePascalCase} Delegation Module
 */
export class ${modulePascalCase}DelegationModule implements DelegationModule {
  readonly name = '${moduleName}';
  readonly type = '${getModuleCategory(moduleType)}';

  private config: ${modulePascalCase}Config | null = null;

  async initialize(config: ${modulePascalCase}Config): Promise<void> {
    // TODO: Validate configuration
    this.config = config;
    console.log(\`[\${this.name}] Initialized\`);
  }

  async delegate<T>(
    session: UserSession,
    action: string,
    params: ${modulePascalCase}Request,
    context?: { sessionId?: string; coreContext?: CoreContext }
  ): Promise<DelegationResult<T>> {
    const auditEntry: AuditEntry = {
      timestamp: new Date(),
      source: \`delegation:\${this.name}\`,
      userId: session.userId,
      action: \`\${this.name}:\${action}\`,
      success: false,
    };

    try {
      if (!this.config) {
        throw new Error(\`\${this.name} module not initialized\`);
      }

      // TODO: Implement delegation logic
      const result = await this.performAction(action, params, session, context);

      auditEntry.success = true;
      return {
        success: true,
        data: result as T,
        auditTrail: auditEntry,
      };
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Unknown error';
      auditEntry.error = errorMessage;

      return {
        success: false,
        error: errorMessage,
        auditTrail: auditEntry,
      };
    }
  }

  /**
   * Perform the delegated action
   */
  private async performAction(
    action: string,
    params: ${modulePascalCase}Request,
    session: UserSession,
    context?: { sessionId?: string; coreContext?: CoreContext }
  ): Promise<any> {
    // TODO: Implement your delegation logic here
    ${getImplementationHint(moduleType)}

    throw new Error(\`Action not implemented: \${action}\`);
  }

  async healthCheck(): Promise<boolean> {
    if (!this.config) {
      return false;
    }

    // TODO: Implement health check logic
    return true;
  }

  async destroy(): Promise<void> {
    this.config = null;
    console.log(\`[\${this.name}] Destroyed\`);
  }
}
`;

// Generate types file
const typesTemplate = `/**
 * ${modulePascalCase} Module Types
 *
 * Type definitions for the ${moduleName} delegation module.
 */

${getAdditionalTypes(moduleType)}
`;

// Generate example usage
const exampleTemplate = `/**
 * ${modulePascalCase} Module Usage Example
 *
 * This example demonstrates how to use the ${moduleName} delegation module.
 */

import { createDelegationTool } from '../src/mcp/tools/delegation-tool-factory.js';
import { ${modulePascalCase}DelegationModule } from '../src/delegation/${moduleName}/index.js';
import { z } from 'zod';

// 1. Create and initialize the module
const ${moduleCamelCase}Module = new ${modulePascalCase}DelegationModule();
await ${moduleCamelCase}Module.initialize({
  ${getExampleConfig(moduleType)}
});

// 2. Register module with delegation registry
const coreContext = server.getCoreContext();
coreContext.delegationRegistry.register(${moduleCamelCase}Module);

// 3. Create MCP tools using the factory

${getExampleTools(moduleType, moduleName, moduleCamelCase)}

// 4. Register tools with the server
server.registerTools([
  exampleTool1,
  // Add more tools here
]);

console.log('${modulePascalCase} delegation tools registered successfully');
`;

// Generate test file
const testTemplate = `/**
 * ${modulePascalCase} Module Tests
 */

import { describe, it, expect, beforeEach } from 'vitest';
import { ${modulePascalCase}DelegationModule } from '../../../src/delegation/${moduleName}/index.js';
import type { UserSession } from '../../../src/core/index.js';

describe('${modulePascalCase}DelegationModule', () => {
  let module: ${modulePascalCase}DelegationModule;
  let mockSession: UserSession;

  beforeEach(async () => {
    module = new ${modulePascalCase}DelegationModule();

    mockSession = {
      userId: 'test-user',
      username: 'testuser',
      role: 'user',
      permissions: ['${moduleName}:read'],
      customClaims: {},
      claims: {
        iss: 'https://test-idp.com',
        sub: 'test-user',
        aud: ['test-audience'],
        exp: Math.floor(Date.now() / 1000) + 3600,
        iat: Math.floor(Date.now() / 1000),
        rawPayload: 'mock.jwt.token',
      },
      authenticated: true,
      rejected: false,
    };
  });

  describe('initialization', () => {
    it('should initialize with valid config', async () => {
      await expect(module.initialize({
        ${getTestConfig(moduleType)}
      })).resolves.not.toThrow();
    });

    it('should have correct module name', () => {
      expect(module.name).toBe('${moduleName}');
    });

    it('should have correct module type', () => {
      expect(module.type).toBe('${getModuleCategory(moduleType)}');
    });
  });

  describe('delegation', () => {
    beforeEach(async () => {
      await module.initialize({
        ${getTestConfig(moduleType)}
      });
    });

    it('should successfully delegate action', async () => {
      const result = await module.delegate(
        mockSession,
        'test-action',
        { /* request params */ },
        { sessionId: 'test-session' }
      );

      // TODO: Update assertions based on your implementation
      expect(result).toBeDefined();
    });

    it('should return error when not initialized', async () => {
      const uninitializedModule = new ${modulePascalCase}DelegationModule();

      const result = await uninitializedModule.delegate(
        mockSession,
        'test-action',
        {}
      );

      expect(result.success).toBe(false);
      expect(result.error).toContain('not initialized');
    });

    it('should include audit trail in result', async () => {
      const result = await module.delegate(
        mockSession,
        'test-action',
        {}
      );

      expect(result.auditTrail).toBeDefined();
      expect(result.auditTrail.userId).toBe('test-user');
      expect(result.auditTrail.source).toBe('delegation:${moduleName}');
    });
  });

  describe('health check', () => {
    it('should return false when not initialized', async () => {
      const health = await module.healthCheck();
      expect(health).toBe(false);
    });

    it('should return true when initialized', async () => {
      await module.initialize({
        ${getTestConfig(moduleType)}
      });

      const health = await module.healthCheck();
      // TODO: Update based on your health check implementation
      expect(health).toBeDefined();
    });
  });

  describe('destroy', () => {
    it('should cleanup resources', async () => {
      await module.initialize({
        ${getTestConfig(moduleType)}
      });

      await expect(module.destroy()).resolves.not.toThrow();
    });
  });
});
`;

// Write files
fs.writeFileSync(path.join(outputDir, 'index.ts'), moduleTemplate);
fs.writeFileSync(path.join(outputDir, 'types.ts'), typesTemplate);

console.log(`‚úÖ Created module implementation: ${outputDir}/index.ts`);
console.log(`‚úÖ Created type definitions: ${outputDir}/types.ts`);

if (generateExamples) {
  const examplesDir = 'examples';
  fs.mkdirSync(examplesDir, { recursive: true });
  fs.writeFileSync(path.join(examplesDir, `${moduleName}-usage.ts`), exampleTemplate);
  console.log(`‚úÖ Created example usage: examples/${moduleName}-usage.ts`);
}

if (generateTests) {
  const testDir = `tests/unit/delegation`;
  fs.mkdirSync(testDir, { recursive: true });
  fs.writeFileSync(path.join(testDir, `${moduleName}.test.ts`), testTemplate);
  console.log(`‚úÖ Created test file: tests/unit/delegation/${moduleName}.test.ts`);
}

console.log(`\n‚ú® Module scaffolding complete!\n`);
console.log('Next steps:');
console.log(`  1. Implement delegation logic in ${outputDir}/index.ts`);
console.log(`  2. Update type definitions in ${outputDir}/types.ts`);
if (generateTests) {
  console.log(`  3. Write tests in tests/unit/delegation/${moduleName}.test.ts`);
}
if (generateExamples) {
  console.log(`  4. Review example usage in examples/${moduleName}-usage.ts`);
}
console.log(`  5. Register module with DelegationRegistry`);
console.log(`  6. Run tests: npm test ${moduleName}`);

// Helper functions
function getModuleDescription(type) {
  const descriptions = {
    'rest-api': 'Delegates MCP operations to REST API endpoints with token exchange',
    'graphql': 'Delegates MCP operations to GraphQL API with query/mutation support',
    'grpc': 'Delegates MCP operations to gRPC services',
    'ldap': 'Delegates authentication and directory operations to LDAP server',
    'filesystem': 'Provides secure filesystem access with user-specific permissions',
    'database': 'Delegates database operations with user impersonation',
    'custom': 'Custom delegation module implementation',
  };
  return descriptions[type] || 'Custom delegation module';
}

function getConfigFields(type) {
  const fields = {
    'rest-api': `baseUrl: string;          // API base URL (e.g., 'https://api.example.com')
  apiKey?: string;        // Optional API key for authentication
  timeout?: number;       // Request timeout in milliseconds
  headers?: Record<string, string>; // Additional headers`,
    'graphql': `endpoint: string;         // GraphQL endpoint URL
  timeout?: number;       // Request timeout in milliseconds
  headers?: Record<string, string>; // Additional headers`,
    'grpc': `serviceUrl: string;      // gRPC service URL
  useTLS?: boolean;       // Use TLS encryption
  timeout?: number;       // Request timeout in milliseconds`,
    'ldap': `url: string;             // LDAP server URL
  baseDN: string;         // Base DN for searches
  bindDN?: string;        // Service account DN
  bindPassword?: string;  // Service account password`,
    'filesystem': `baseDirectory: string;   // Base directory for operations
  allowedPaths?: string[];// Whitelist of allowed paths
  maxFileSize?: number;   // Maximum file size in bytes`,
    'database': `connectionString: string; // Database connection string
  poolSize?: number;      // Connection pool size
  timeout?: number;       // Query timeout in milliseconds`,
    'custom': `// TODO: Add your configuration fields here
  endpoint?: string;
  timeout?: number;`,
  };
  return fields[type] || fields['custom'];
}

function getRequestFields(type) {
  const fields = {
    'rest-api': `endpoint: string;        // API endpoint path
  method?: string;        // HTTP method (GET, POST, etc.)
  body?: any;             // Request body
  params?: Record<string, any>; // Query parameters`,
    'graphql': `query: string;           // GraphQL query or mutation
  variables?: Record<string, any>; // Query variables
  operationName?: string; // Operation name`,
    'grpc': `method: string;          // gRPC method name
  message: Record<string, any>; // Request message`,
    'ldap': `filter: string;          // LDAP filter
  attributes?: string[];  // Attributes to return`,
    'filesystem': `path: string;            // File path
  operation: string;      // Operation (read, write, delete, etc.)
  content?: string;       // File content (for write)`,
    'database': `query: string;           // SQL query or stored procedure
  params?: Record<string, any>; // Query parameters`,
    'custom': `// TODO: Add your request fields here
  action?: string;
  params?: any;`,
  };
  return fields[type] || fields['custom'];
}

function getModuleCategory(type) {
  const categories = {
    'rest-api': 'api',
    'graphql': 'api',
    'grpc': 'api',
    'ldap': 'authentication',
    'filesystem': 'storage',
    'database': 'database',
    'custom': 'custom',
  };
  return categories[type] || 'custom';
}

function getImplementationHint(type) {
  const hints = {
    'rest-api': `// Example implementation:
    // const response = await fetch(\`\${this.config.baseUrl}/\${params.endpoint}\`, {
    //   method: params.method || 'GET',
    //   headers: { 'Authorization': \`Bearer \${session.claims.rawPayload}\` },
    //   body: JSON.stringify(params.body),
    // });
    // return await response.json();`,
    'graphql': `// Example implementation:
    // const response = await fetch(this.config.endpoint, {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify({ query: params.query, variables: params.variables }),
    // });
    // return await response.json();`,
    'grpc': `// Example implementation:
    // Use @grpc/grpc-js to call gRPC service
    // const client = new YourServiceClient(this.config.serviceUrl);
    // return await client.callMethod(params.message);`,
    'ldap': `// Example implementation:
    // Use ldapjs to perform LDAP operations
    // const client = ldap.createClient({ url: this.config.url });
    // return await client.search(this.config.baseDN, { filter: params.filter });`,
    'filesystem': `// Example implementation:
    // Use fs/promises to perform file operations
    // const fullPath = path.join(this.config.baseDirectory, params.path);
    // return await fs.readFile(fullPath, 'utf8');`,
    'database': `// Example implementation:
    // Use database client to execute queries
    // const result = await this.dbClient.query(params.query, params.params);
    // return result.rows;`,
    'custom': `// TODO: Implement your custom delegation logic here`,
  };
  return hints[type] || hints['custom'];
}

function getAdditionalTypes(type) {
  return `// TODO: Add additional type definitions as needed

export interface ${type === 'custom' ? 'Custom' : ''}Response {
  // Define your response types here
}
`;
}

function getExampleConfig(type) {
  const configs = {
    'rest-api': `baseUrl: 'https://api.example.com',
  timeout: 30000,`,
    'graphql': `endpoint: 'https://api.example.com/graphql',
  timeout: 30000,`,
    'grpc': `serviceUrl: 'localhost:50051',
  useTLS: true,`,
    'ldap': `url: 'ldaps://dc.example.com:636',
  baseDN: 'DC=example,DC=com',`,
    'filesystem': `baseDirectory: '/var/app/data',
  maxFileSize: 10 * 1024 * 1024,`,
    'database': `connectionString: 'postgresql://localhost/mydb',
  poolSize: 10,`,
    'custom': `// Add your configuration here`,
  };
  return configs[type] || configs['custom'];
}

function getTestConfig(type) {
  const configs = {
    'rest-api': `baseUrl: 'https://test-api.example.com',
        timeout: 5000,`,
    'graphql': `endpoint: 'https://test-api.example.com/graphql',
        timeout: 5000,`,
    'grpc': `serviceUrl: 'localhost:50051',
        useTLS: false,`,
    'ldap': `url: 'ldap://localhost:389',
        baseDN: 'DC=test,DC=com',`,
    'filesystem': `baseDirectory: './test-data',
        maxFileSize: 1024,`,
    'database': `connectionString: 'postgresql://localhost/testdb',
        poolSize: 1,`,
    'custom': `// Test configuration`,
  };
  return configs[type] || configs['custom'];
}

function getExampleTools(type, moduleName, moduleCamelCase) {
  return `const exampleTool1 = createDelegationTool('${moduleName}', {
  name: '${moduleName}-action',
  description: 'Example tool for ${moduleName} module',

  parameters: z.object({
    // Define your parameters here
    id: z.string().describe('Resource ID'),
  }),

  action: 'example-action',
  requiredPermission: '${moduleName}:read',

  transformParams: (params) => ({
    // Transform MCP parameters to module request format
    ...params,
  }),

  transformResult: (result) => ({
    // Transform module response for LLM
    data: result,
  }),
}, coreContext);`;
}
