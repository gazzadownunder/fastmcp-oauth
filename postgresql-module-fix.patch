# PostgreSQL Module Fixes - Apply All At Once
# This patch fixes the undefined teRoles variable issue

## Fix #1: Extract roles from TE-JWT (after line 366)

LOCATION: After "effectiveLegacyUsername = claimValue as string;"

ADD THIS CODE:
```typescript
        // Extract roles from TE-JWT (may be in 'roles', 'user_roles', or other claim)
        const rolesClaimPath = this.tokenExchangeConfig.rolesClaim || 'roles';
        const teRoles = (Array.isArray(teClaims?.[rolesClaimPath])
          ? teClaims[rolesClaimPath]
          : []) as string[];
```

UPDATE THE CONSOLE.LOG (line 368-371):
```typescript
        console.log('[PostgreSQLModule] Token exchange successful:', {
          legacyUsername: effectiveLegacyUsername,
          roles: teRoles,  // ADD THIS LINE
          rolesClaimPath,  // ADD THIS LINE
          idpName: this.tokenExchangeConfig.idpName,
        });
```

## Fix #2: Fix incorrect this.tokenExchangeService reference (line 456)

CHANGE:
```typescript
            tokenExchangeUsed: !!this.tokenExchangeService,
```

TO:
```typescript
            tokenExchangeUsed: !!this.tokenExchangeConfig,
```

## Fix #3: Add rolesClaim to TokenExchangeConfig interface (around line 48)

ADD THIS FIELD to the interface:
```typescript
export interface TokenExchangeConfig {
  /** IDP name from auth.trustedIDPs to use for TE-JWT validation */
  idpName: string;

  /** Token exchange endpoint URL */
  tokenEndpoint: string;

  /** Client ID for token exchange */
  clientId: string;

  /** Client secret for token exchange */
  clientSecret: string;

  /** Expected audience for TE-JWT */
  audience?: string;

  /** Required claim in TE-JWT (e.g., legacy_name) */
  requiredClaim?: string;

  /** Roles claim path in TE-JWT (default: 'roles') */  // ADD THIS
  rolesClaim?: string;                                    // ADD THIS

  /** Token cache configuration */
  cache?: {
    enabled?: boolean;
    ttlSeconds?: number;
    sessionTimeoutMs?: number;
    maxEntriesPerSession?: number;
    maxTotalEntries?: number;
  };
}
```

## After applying these fixes:
1. Run: npm run build
2. Restart the server
3. Test token exchange with sql-schema tool
